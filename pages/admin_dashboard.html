<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torre de Control | BOXROOMER Admin</title>

    <!-- Icons & Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&family=Outfit:wght@300;400;500;700;900&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../assets/js/tailwind.config.js"></script>

    <style>
        body {
            font-family: 'Outfit', sans-serif;
        }

        /* Style for date input to look better in dark mode */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        .toggle-container {
            display: flex;
            position: relative;
            user-select: none;
        }

        .sliding-pill {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            height: calc(100% - 8px);
            background: #7312e0;
            border-radius: 0.75rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(115, 18, 224, 0.4);
        }
    </style>
</head>

<body class="bg-brandDark text-white h-screen overflow-hidden flex">

    <!-- Sidebar -->
    <aside class="w-64 bg-[#111] border-r border-white/5 flex flex-col justify-between p-6">
        <div>
            <div class="flex items-center gap-3 mb-10 opacity-80 hover:opacity-100 transition-opacity cursor-pointer">
                <img src="../assets/images/logo.png" alt="LOGO" class="h-6 brightness-0 invert">
                <span
                    class="bg-brandPurple text-white text-[9px] font-black px-1.5 py-0.5 rounded uppercase tracking-widest">Admin</span>
            </div>

            <nav class="space-y-2">
                <a href="admin_dashboard.html"
                    class="flex items-center gap-3 px-4 py-3 rounded-xl bg-brandPurple/20 text-white border border-brandPurple/20 shadow-lg shadow-brandPurple/10">
                    <span class="material-symbols-outlined text-brandPurple">space_dashboard</span>
                    <span class="text-xs font-bold uppercase tracking-wider">Dashboard</span>
                </a>
                <a href="admin_clientes.html"
                    class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white transition-colors">
                    <span class="material-symbols-outlined">group</span>
                    <span class="text-xs font-bold uppercase tracking-wider">Clientes</span>
                </a>
                <a href="admin_logistica.html"
                    class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white transition-colors">
                    <span class="material-symbols-outlined">inventory_2</span>
                    <span class="text-xs font-bold uppercase tracking-wider">Log√≠stica</span>
                </a>
                <a href="admin_facturacion.html"
                    class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white transition-colors">
                    <span class="material-symbols-outlined">payments</span>
                    <span class="text-xs font-bold uppercase tracking-wider">Facturaci√≥n</span>
                </a>
                <a href="admin_ajustes.html"
                    class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white transition-colors">
                    <span class="material-symbols-outlined">settings</span>
                    <span class="text-xs font-bold uppercase tracking-wider">Ajustes</span>
                </a>
            </nav>
        </div>

        <div class="px-4 py-3 bg-brandPurple/10 rounded-xl border border-brandPurple/20">
            <p class="text-[10px] text-brandPurple font-black uppercase tracking-widest mb-1">Estado del Sistema</p>
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                <span class="text-xs font-bold text-white">Operativo</span>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto bg-[#0a0a0a] p-8">

        <!-- Header -->
        <header class="flex justify-between items-end mb-10">
            <div>
                <h1 class="text-3xl font-black tracking-tight">Torre de Control</h1>
                <p class="text-slate-400 text-sm font-medium mt-1">Visi√≥n global de operaciones en tiempo real</p>
            </div>
            <div class="flex gap-4">
                <button
                    class="w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center text-slate-400 hover:text-white transition-colors">
                    <span class="material-symbols-outlined">notifications</span>
                </button>
                <div class="flex items-center gap-3 pl-4 border-l border-white/10">
                    <div class="text-right">
                        <p class="text-xs font-black text-white">Admin User</p>
                        <p class="text-[10px] text-slate-500 font-bold uppercase">Superadmin</p>
                    </div>
                    <div class="w-9 h-9 rounded-full bg-gradient-to-br from-brandPurple to-blue-600"></div>
                </div>
            </div>
        </header>

        <!-- KPI Grid -->
        <div class="grid grid-cols-4 gap-6 mb-10">
            <!-- KPI 1 -->
            <div class="bg-[#141414] border border-white/5 p-5 rounded-2xl relative overflow-hidden group">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <span class="material-symbols-outlined text-4xl">person_add</span>
                </div>
                <p class="text-slate-500 text-[10px] font-black uppercase tracking-widest mb-2">Nuevos Clientes (30d)
                </p>
                <h3 class="text-3xl font-black text-white">42</h3>
                <div class="flex gap-2 mt-2">
                    <span class="text-[10px] text-green-500 font-bold bg-green-500/10 px-1.5 py-0.5 rounded">+15%</span>
                    <span class="text-[10px] text-slate-500">vs mes anterior</span>
                </div>
            </div>
            <!-- KPI 2 -->
            <div class="bg-[#141414] border border-white/5 p-5 rounded-2xl relative overflow-hidden group">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <span class="material-symbols-outlined text-4xl">inventory</span>
                </div>
                <p class="text-slate-500 text-[10px] font-black uppercase tracking-widest mb-2">Bultos Totales</p>
                <h3 class="text-3xl font-black text-white">1,248</h3>
                <div class="flex gap-2 mt-2">
                    <span class="text-[10px] text-green-500 font-bold bg-green-500/10 px-1.5 py-0.5 rounded">+12</span>
                    <span class="text-[10px] text-slate-500">hoy</span>
                </div>
            </div>
            <!-- KPI 3 -->
            <div class="bg-[#141414] border border-white/5 p-5 rounded-2xl relative overflow-hidden group">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <span class="material-symbols-outlined text-4xl">local_shipping</span>
                </div>
                <p class="text-slate-500 text-[10px] font-black uppercase tracking-widest mb-2">Rutas Activas</p>
                <h3 class="text-3xl font-black text-white">3</h3>
                <div class="flex gap-2 mt-2">
                    <span class="text-[10px] text-orange-500 font-bold bg-orange-500/10 px-1.5 py-0.5 rounded">En
                        camino</span>
                </div>
            </div>
            <!-- KPI 4 -->
            <div class="bg-[#141414] border border-white/5 p-5 rounded-2xl relative overflow-hidden group">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <span class="material-symbols-outlined text-4xl">euro</span>
                </div>
                <p class="text-slate-500 text-[10px] font-black uppercase tracking-widest mb-2">MRR (Ingresos)</p>
                <h3 class="text-3xl font-black text-white">12.4k</h3>
                <div class="flex gap-2 mt-2">
                    <span
                        class="text-[10px] text-green-500 font-bold bg-green-500/10 px-1.5 py-0.5 rounded">+580‚Ç¨</span>
                    <span class="text-[10px] text-slate-500">nuevos hoy</span>
                </div>
            </div>
        </div>

        <!-- Recent Orders Table -->
        <h2 class="text-lg font-black uppercase tracking-wider mb-6 flex items-center gap-3">
            <span class="w-2 h-2 rounded-full bg-brandPurple"></span>
            √öltimas Reservas (Live)
        </h2>

        <div class="bg-[#141414] border border-white/5 rounded-2xl overflow-hidden mb-10">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-white/5 text-[10px] font-black text-slate-400 uppercase tracking-widest">
                        <th class="p-4">Cliente</th>
                        <th class="p-4">Plan / Volumen</th>
                        <th class="p-4">Direcci√≥n</th>
                        <th class="p-4">Fecha Recogida</th>
                        <th class="p-4">Estado</th>
                        <th class="p-4 text-right">Acciones</th>
                    </tr>
                </thead>
                <tbody class="text-sm font-medium text-slate-300 divide-y divide-white/5" id="orders-table-body">
                    <!-- Javascript will populate this -->
                </tbody>
            </table>
        </div>
    </main>

    <!-- Edit Order Modal -->
    <div id="editModal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
        <div class="bg-[#1a1a1a] border border-white/10 w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl">
            <h3 class="text-xl font-black mb-6 uppercase tracking-tight flex items-center gap-3">
                <span class="material-symbols-outlined text-brandPurple">edit_calendar</span>
                Gestionar Log√≠stica
            </h3>

            <div class="space-y-6">
                <div>
                    <label class="text-[10px] font-black uppercase text-slate-500 mb-2 block tracking-widest">Nueva
                        Fecha de Recogida</label>
                    <div class="relative">
                        <span
                            class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-brandPurple text-xl">calendar_today</span>
                        <input type="date" id="editPickupDate"
                            class="w-full bg-white/5 border border-white/10 rounded-2xl py-4 pl-12 pr-4 text-white font-bold outline-none focus:border-brandPurple transition-all [color-scheme:dark]">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-slate-500 mb-2 block tracking-widest">Franja
                        Horaria</label>
                    <div id="edit-time-toggle"
                        class="toggle-container dark-theme bg-white/5 p-1 rounded-2xl relative cursor-pointer">
                        <div id="pill-edit-time" class="sliding-pill w-[calc(50%-4px)] left-1">
                        </div>
                        <button onclick="setEditTime('Ma√±ana (09:00 - 14:00)', this)" id="edit-btn-morning"
                            class="relative z-10 py-3.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all flex-1 flex items-center justify-center gap-2 text-white active">
                            <span class="material-symbols-outlined text-sm">light_mode</span> Ma√±ana
                        </button>
                        <button onclick="setEditTime('Tarde (14:00 - 18:00)', this)" id="edit-btn-afternoon"
                            class="relative z-10 py-3.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all flex-1 flex items-center justify-center gap-2 text-white/40">
                            <span class="material-symbols-outlined text-sm">dark_mode</span> Tarde
                        </button>
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-slate-500 mb-2 block tracking-widest">Estado del
                        Servicio</label>
                    <select id="editStatus"
                        class="w-full bg-white/5 border border-white/10 rounded-2xl py-4 px-4 text-white font-bold outline-none focus:border-brandPurple transition-all appearance-none [color-scheme:dark]">
                        <option value="pending_pickup" class="bg-[#1a1a1a]">Pendiente Recogida</option>
                        <option value="picking_up" class="bg-[#1a1a1a]">Recogida en curso</option>
                        <option value="in_transit" class="bg-[#1a1a1a]">En tr√°nsito a Pinto</option>
                        <option value="active" class="bg-[#1a1a1a]">En Almac√©n (Pinto)</option>
                        <option value="retrieval_requested" class="bg-[#1a1a1a]">Devoluci√≥n Solicitada</option>
                        <option value="delivering" class="bg-[#1a1a1a]">Entrega en curso</option>
                        <option value="completed" class="bg-[#1a1a1a]">Finalizado / Entregado</option>
                        <option value="canceled" class="bg-[#1a1a1a]">Cancelado</option>
                    </select>
                </div>
            </div>

            <div class="flex gap-3 mt-8">
                <button onclick="closeEditModal()"
                    class="flex-1 py-4 rounded-xl bg-white/5 text-[10px] font-black uppercase tracking-widest hover:bg-white/10 transition-all">Cancelar</button>
                <button onclick="saveAdminChanges(event)"
                    class="flex-1 py-4 rounded-xl bg-brandPurple text-white text-[10px] font-black uppercase tracking-widest shadow-lg shadow-brandPurple/20 hover:scale-105 transition-all">Guardar
                    Cambios</button>
            </div>
        </div>
    </div>

    <!-- Context Menu (Dropdown) -->
    <!-- Context Menu (Dropdown) -->
    <div id="rowMenu"
        class="fixed bg-[#1a1a1a] border border-white/10 rounded-2xl shadow-2xl py-2 z-[200] hidden w-52 backdrop-blur-xl">
        <button onclick="menuAction('detalles')"
            class="w-full text-left px-4 py-3 text-[10px] font-black uppercase text-slate-300 hover:bg-brandPurple hover:text-white flex items-center gap-3 transition-colors">
            <span class="material-symbols-outlined text-sm">visibility</span> Ver Ficha Cliente
        </button>
        <button onclick="menuAction('whatsapp')"
            class="w-full text-left px-4 py-3 text-[10px] font-black uppercase text-slate-300 hover:bg-green-600 hover:text-white flex items-center gap-3 transition-colors">
            <span class="material-symbols-outlined text-sm font-bold">chat</span> Enviar WhatsApp
        </button>
        <button onclick="menuAction('email')"
            class="w-full text-left px-4 py-3 text-[10px] font-black uppercase text-slate-300 hover:bg-blue-600 hover:text-white flex items-center gap-3 transition-colors">
            <span class="material-symbols-outlined text-sm">mail</span> Enviar Correo
        </button>
        <div class="h-[1px] bg-white/5 my-2"></div>
        <button onclick="menuAction('ruta')"
            class="w-full text-left px-4 py-3 text-[10px] font-black uppercase text-slate-300 hover:bg-white/10 flex items-center gap-3 transition-colors">
            <span class="material-symbols-outlined text-sm font-bold">map</span> Ver Direcci√≥n
        </button>
        <button onclick="menuAction('cancelar')"
            class="w-full text-left px-4 py-3 text-[10px] font-black uppercase text-red-500 hover:bg-red-500 hover:text-white flex items-center gap-3 transition-colors">
            <span class="material-symbols-outlined text-sm">cancel</span> Anular Servicio
        </button>
    </div>

    <!-- Communication Modal -->
    <div id="commModal"
        class="fixed inset-0 bg-black/90 backdrop-blur-md z-[250] hidden items-center justify-center p-4">
        <div
            class="bg-[#1a1a1a] border border-white/10 w-full max-w-4xl rounded-[3rem] overflow-hidden shadow-2xl flex h-[80vh]">
            <!-- Editor -->
            <div class="w-1/2 p-10 border-r border-white/5 flex flex-col font-sans">
                <h3 id="comm-title" class="text-2xl font-black mb-8 uppercase tracking-tighter italic text-white">
                    Comunicaci√≥n Directa</h3>

                <div class="space-y-6 flex-1 overflow-y-auto pr-4 scrollbar-hide">
                    <div id="email-fields">
                        <label class="text-[10px] font-black uppercase text-slate-500 mb-2 block tracking-widest">Asunto
                            del Correo</label>
                        <input type="text" id="comm-subject"
                            class="w-full bg-white/5 border border-white/10 rounded-2xl py-4 px-6 text-white text-xs outline-none focus:border-brandPurple mb-6"
                            value="Actualizaci√≥n de tu suscripci√≥n BOXROOMER">
                    </div>

                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-500 mb-2 block tracking-widest">Cuerpo
                            del Mensaje</label>
                        <textarea id="comm-body" rows="8"
                            class="w-full bg-white/5 border border-white/10 rounded-2xl py-4 px-6 text-white text-xs outline-none focus:border-brandPurple resize-none"
                            oninput="updateEmailPreview()">Estimado/a cliente, le contactamos para informarle sobre su pr√≥xima recogida...</textarea>
                    </div>

                    <div id="channel-badge"
                        class="inline-flex items-center gap-2 bg-brandPurple/10 text-brandPurple px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest">
                        Canal: Correo Corporativo
                    </div>
                </div>

                <div class="flex gap-4 mt-8 pt-8 border-t border-white/5">
                    <button onclick="closeCommModal()"
                        class="flex-1 py-4 rounded-2xl bg-white/5 text-[10px] font-black uppercase tracking-widest hover:bg-white/10 transition-all text-white">Cancelar</button>
                    <button id="send-btn" onclick="executeComm()"
                        class="flex-1 py-4 rounded-2xl bg-brandPurple text-white text-[10px] font-black uppercase tracking-widest shadow-lg shadow-brandPurple/20 hover:scale-105 transition-all">Enviar
                        Mensaje</button>
                </div>
            </div>

            <!-- Preview -->
            <div class="w-1/2 bg-[#0a0a0a] p-10 flex flex-col">
                <p class="text-[10px] font-black uppercase text-slate-600 mb-4 tracking-widest text-center">Vista Previa
                    (Dise√±o Real)</p>

                <div id="email-preview-container"
                    class="bg-white rounded-[2rem] flex-1 overflow-hidden shadow-2xl flex flex-col font-sans">
                    <!-- Email Header -->
                    <div class="bg-slate-900 p-8 flex justify-center">
                        <img src="../assets/images/logo.png" alt="BOXROOMER" class="h-6 brightness-0 invert">
                    </div>
                    <!-- Email Content -->
                    <div class="p-10 text-slate-800">
                        <h1 id="preview-subject" class="text-xl font-bold mb-6 text-slate-900 tracking-tight">
                            Actualizaci√≥n de tu suscripci√≥n</h1>
                        <p id="preview-body" class="text-sm leading-relaxed text-slate-600 whitespace-pre-line">
                            Estimado/a cliente, le contactamos para informarle sobre su pr√≥xima recogida...</p>

                        <div class="mt-10 pt-10 border-t border-slate-100 italic text-[11px] text-slate-400">
                            Atentamente,<br>
                            <strong>Equipo de Operativa BOXROOMER</strong><br>
                            Madrid, Espa√±a ‚Ä¢ correo@boxroomer.com
                        </div>
                    </div>
                    <!-- Email Footer -->
                    <div class="bg-slate-50 p-6 text-center">
                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Tu trastero en el
                            bolsillo</p>
                    </div>
                </div>

                <div id="whatsapp-preview-container" class="hidden flex-1 flex items-end justify-start pb-10">
                    <div
                        class="bg-[#dcf8c6] text-[#075e54] p-4 rounded-2xl rounded-bl-none shadow-md max-w-[80%] relative font-sans">
                        <p id="preview-body-wa" class="text-xs whitespace-pre-line font-medium"></p>
                        <span class="text-[8px] opacity-50 block text-right mt-1">10:59 ‚úì‚úì</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedEditTime = "Ma√±ana (09:00 - 14:00)";

        document.addEventListener('DOMContentLoaded', () => {
            renderTable();
        });

        function setEditTime(time, btn) {
            selectedEditTime = time;
            const morningBtn = document.getElementById('edit-btn-morning');
            const afternoonBtn = document.getElementById('edit-btn-afternoon');
            const pill = document.getElementById('pill-edit-time');

            // If no button is passed (e.g. from openEditModal), pick the right one
            if (!btn) {
                btn = time.includes('Ma√±ana') ? morningBtn : afternoonBtn;
            }

            // Toggle active classes
            [morningBtn, afternoonBtn].forEach(b => {
                b.classList.remove('active', 'text-white');
                b.classList.add('text-white/40');
            });
            btn.classList.add('active', 'text-white');
            btn.classList.remove('text-white/40');

            if (time.includes('Ma√±ana')) {
                if (pill) pill.style.transform = 'translateY(-50%) translateX(0)';
            } else {
                if (pill) pill.style.transform = 'translateY(-50%) translateX(100%)';
            }
        }

        function renderTable() {
            const dataStr = localStorage.getItem('BOXROOMER_DASHBOARD_DATA');
            const tableBody = document.getElementById('orders-table-body');

            tableBody.innerHTML = `
                <tr class="hover:bg-white/5 transition-colors opacity-50">
                    <td class="p-4">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-blue-500/20 text-blue-400 flex items-center justify-center font-bold text-xs">AG</div>
                            <div>
                                <p class="text-white font-bold">Ana Garc√≠a</p>
                                <p class="text-[10px] text-slate-500">HIST√ìRICO ‚Ä¢ #8821</p>
                            </div>
                        </div>
                    </td>
                    <td class="p-4">
                        <span class="block text-white font-bold">Pack Mini</span>
                        <span class="text-xs text-slate-500">1.0 m¬≥</span>
                    </td>
                    <td class="p-4 text-slate-400 truncate max-w-[150px]">C/ Vel√°zquez 45, Madrid</td>
                    <td class="p-4 text-white">Prox. Lunes</td>
                    <td class="p-4">
                        <span class="bg-blue-500/10 text-blue-400 text-[10px] font-black px-2 py-1 rounded uppercase">Confirmado</span>
                    </td>
                    <td class="p-4 text-right pr-6 relative">
                        <button onclick="toggleRowMenu(event, 'HISTORICO')" class="text-slate-600 hover:text-white transition-colors">
                            <span class="material-symbols-outlined">more_vert</span>
                        </button>
                    </td>
                </tr>
            `;

            if (dataStr) {
                const data = JSON.parse(dataStr);
                const isNew = data.status === 'pending_pickup';
                const newRow = document.createElement('tr');

                newRow.className = `${isNew ? 'bg-brandPurple/5 border-l-4 border-brandPurple' : 'hover:bg-white/5'} transition-colors`;

                newRow.innerHTML = `
                    <td class="p-4">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-brandPurple text-white flex items-center justify-center font-bold text-xs">
                                ${data.userName ? data.userName.charAt(0).toUpperCase() : 'U'}
                            </div>
                            <div>
                                <p class="text-white font-bold">${data.userName || 'Usuario'}</p>
                                <p class="text-[10px] text-slate-400">${isNew ? 'üîî NUEVA RESERVA' : 'üì¶ GESTI√ìN ACTIVA'}</p>
                            </div>
                        </div>
                    </td>
                    <td class="p-4">
                        <span class="block text-white font-bold">${data.plan || 'Plan'}</span>
                        <span class="text-xs text-slate-400">${data.volume || '0'} m¬≥</span>
                    </td>
                    <td class="p-4 text-slate-400 truncate max-w-[150px] italic">${data.address || '‚Äî'}</td>
                    <td class="p-4">
                        <span class="block text-white font-black">${data.pickupDate || 'Indefinida'}</span>
                        <span class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">${data.pickupTime || 'Pendiente'}</span>
                    </td>
                    <td class="p-4">
                        <span class="${isNew ? 'bg-orange-500/20 text-orange-400' : 'bg-green-500/20 text-green-400'} text-[9px] font-black px-2 py-1 rounded uppercase tracking-widest">
                            ${isNew ? 'Pend. Log√≠stica' : 'Todo Seguro'}
                        </span>
                    </td>
                    <td class="p-4 text-right pr-6 relative">
                        <div class="flex items-center justify-end gap-2">
                            <button onclick="openEditModal()" class="w-9 h-9 rounded-xl bg-white/5 border border-white/10 text-slate-400 hover:bg-brandPurple hover:text-white transition-all flex items-center justify-center group">
                                <span class="material-symbols-outlined text-sm">edit</span>
                            </button>
                            <button onclick="toggleRowMenu(event, '${data.id || 'NEW'}')" class="w-9 h-9 rounded-xl bg-white/5 border border-white/10 text-slate-400 hover:bg-white/10 transition-all flex items-center justify-center">
                                <span class="material-symbols-outlined text-sm font-bold">more_vert</span>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.insertBefore(newRow, tableBody.firstChild);
            }
        }

        function openEditModal() {
            const data = JSON.parse(localStorage.getItem('BOXROOMER_DASHBOARD_DATA'));
            if (!data) return;

            // Leave date blank for new selection to trigger change, or use a default
            document.getElementById('editPickupDate').value = "";
            setEditTime(data.pickupTime || "Ma√±ana (09:00 - 14:00)");
            document.getElementById('editStatus').value = data.status || "pending_pickup";

            const modal = document.getElementById('editModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeEditModal() {
            const modal = document.getElementById('editModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function saveAdminChanges(e) {
            const data = JSON.parse(localStorage.getItem('BOXROOMER_DASHBOARD_DATA'));
            if (!data) return;

            const dateValue = document.getElementById('editPickupDate').value;
            if (dateValue) {
                const date = new Date(dateValue);
                const days = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
                const monthsArr = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                data.pickupDate = `${days[date.getDay()]} ${date.getDate()} ${monthsArr[date.getMonth()]}`;
            }

            data.pickupTime = selectedEditTime;
            data.status = document.getElementById('editStatus').value;

            localStorage.setItem('BOXROOMER_DASHBOARD_DATA', JSON.stringify(data));

            const saveBtn = e.currentTarget;
            const originalText = saveBtn.innerText;
            saveBtn.innerHTML = '<span class="material-symbols-outlined animate-spin text-sm">sync</span> Guardando...';
            saveBtn.disabled = true;

            setTimeout(() => {
                closeEditModal();
                renderTable();
                saveBtn.innerText = originalText;
                saveBtn.disabled = false;

                // Track Audit Log
                addAuditLog('GESTI√ìN_SERVICIO', `Cambio de estado a ${data.status} y fecha a ${data.pickupDate}`, 'ALTA', 'DASHBOARD', 'DASH');
            }, 800);
        }

        let commChannel = 'email';

        function toggleRowMenu(e, id) {
            e.stopPropagation();
            const menu = document.getElementById('rowMenu');
            const isVisible = !menu.classList.contains('hidden');

            if (isVisible) {
                menu.classList.add('hidden');
            } else {
                menu.classList.remove('hidden');
                menu.style.left = `${e.clientX - 180}px`;
                menu.style.top = `${e.clientY + 10}px`;
            }

            document.addEventListener('click', () => {
                menu.classList.add('hidden');
            }, { once: true });
        }

        function menuAction(action) {
            const data = JSON.parse(localStorage.getItem('BOXROOMER_DASHBOARD_DATA'));
            const clientName = data ? data.userName : "Cliente Principal";

            if (action === 'detalles') {
                window.location.href = 'admin_clientes.html';
                return;
            }

            if (action === 'email' || action === 'whatsapp') {
                commChannel = action;
                openCommModal(clientName);
            } else if (action === 'cancelar') {
                if (confirm('¬øAnular este servicio definitivamente? Se notificar√° al equipo log√≠stico.')) {
                    addAuditLog('ANULACION_ORDEN', `Servicio anulado para ${clientName}`, 'ALTA', 'DASHBOARD', 'DASH');
                    alert('Servicio anulado y equipo de ruta notificado.');
                }
            } else if (action === 'ruta') {
                // alert('Abriendo direcci√≥n en Google Maps: ' + (data ? data.address : 'Calle Principal 123'));
                window.location.href = 'admin_logistica.html?highlight_user=true';
            }
        }

        function openCommModal(name) {
            document.getElementById('commModal').classList.remove('hidden');
            document.getElementById('commModal').classList.add('flex');

            const badge = document.getElementById('channel-badge');
            const emailFields = document.getElementById('email-fields');
            const emailContainer = document.getElementById('email-preview-container');
            const waContainer = document.getElementById('whatsapp-preview-container');
            const bodyTextarea = document.getElementById('comm-body');

            if (commChannel === 'email') {
                badge.innerText = "Canal: Correo Corporativo";
                badge.className = "inline-flex items-center gap-2 bg-blue-500/10 text-blue-500 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest";
                emailFields.classList.remove('hidden');
                emailContainer.classList.remove('hidden');
                waContainer.classList.add('hidden');
                bodyTextarea.value = `Estimado/a ${name},\n\nLe contactamos desde BOXROOMER para informarle de que su recogida ha sido programada con √©xito...\n\nSi tiene cualquier duda puede contactarnos respondiendo a este correo.`;
            } else {
                badge.innerText = "Canal: WhatsApp Directo";
                badge.className = "inline-flex items-center gap-2 bg-green-500/10 text-green-500 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest";
                emailFields.classList.add('hidden');
                emailContainer.classList.add('hidden');
                waContainer.classList.remove('hidden');
                bodyTextarea.value = `Hola ${name}, soy de BOXROOMER. Te escribo por tu pr√≥xima recogida. ¬øTe viene bien el horario seleccionado? ¬°Gracias!`;
            }
            updateEmailPreview();
        }

        function closeCommModal() {
            document.getElementById('commModal').classList.add('hidden');
            document.getElementById('commModal').classList.remove('flex');
        }

        function updateEmailPreview() {
            const subject = document.getElementById('comm-subject').value;
            const body = document.getElementById('comm-body').value;

            document.getElementById('preview-subject').innerText = subject;
            document.getElementById('preview-body').innerText = body;
            document.getElementById('preview-body-wa').innerText = body;
        }

        function executeComm() {
            const btn = document.getElementById('send-btn');
            const originalText = btn.innerText;
            const data = JSON.parse(localStorage.getItem('BOXROOMER_DASHBOARD_DATA'));
            const clientName = data ? data.userName : "Cliente Principal";

            btn.innerHTML = '<span class="material-symbols-outlined animate-spin text-sm">sync</span> Enviando...';
            btn.disabled = true;

            setTimeout(() => {
                btn.innerText = '¬°Enviado!';
                btn.classList.replace('bg-brandPurple', 'bg-green-500');

                // Traceability
                const actionType = commChannel === 'email' ? 'NOTIF_EMAIL' : 'NOTIF_WHATSAPP';
                const details = commChannel === 'email' ? `Email enviado con asunto: ${document.getElementById('comm-subject').value}` : 'Mensaje de WhatsApp enviado';

                addAuditLog(actionType, details, 'INFO', clientName, 'DASHBOARD');

                // Track in Client Specific History
                const history = JSON.parse(localStorage.getItem('BOXROOMER_CLIENT_HISTORY') || '[]');
                history.unshift({
                    client: clientName,
                    action: actionType,
                    details: details,
                    timestamp: new Date().toISOString(),
                    admin: 'Admin Principal'
                });
                localStorage.setItem('BOXROOMER_CLIENT_HISTORY', JSON.stringify(history.slice(0, 50)));

                setTimeout(() => {
                    closeCommModal();
                    btn.innerText = originalText;
                    btn.classList.replace('bg-green-500', 'bg-brandPurple');
                    btn.disabled = false;
                    alert('Comunicaci√≥n registrada y enviada correctamente.');
                }, 1000);
            }, 1200);
        }

        function addAuditLog(action, details, level, target, origin) {
            const logs = JSON.parse(localStorage.getItem('BOXROOMER_AUDIT_LOG') || '[]');
            logs.unshift({
                timestamp: new Date().toISOString(),
                action,
                details,
                level,
                target,
                origin,
                admin: 'Admin Principal'
            });
            localStorage.setItem('BOXROOMER_AUDIT_LOG', JSON.stringify(logs.slice(0, 100)));
        }
    </script>
</body>

</html>