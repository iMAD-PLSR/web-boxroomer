<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torre de Control | BOXROOMER Admin</title>

    <!-- Icons & Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&family=Outfit:wght@300;400;500;700;900&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../assets/js/tailwind.config.js"></script>

    <style>
        body {
            font-family: 'Outfit', sans-serif;
        }

        /* Style for date input to look better in dark mode */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        .toggle-container {
            display: flex;
            position: relative;
            user-select: none;
        }

        .sliding-pill {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            height: calc(100% - 8px);
            background: #7312e0;
            border-radius: 0.75rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(115, 18, 224, 0.4);
        }
    </style>
</head>

<body class="bg-brandDark text-white h-screen overflow-hidden flex">

    <!-- Sidebar -->
    <aside
        class="w-64 bg-[#111] border-r border-white/5 flex flex-col justify-between p-6 shrink-0 overflow-y-auto scrollbar-hide">
        <div class="pb-8">
            <div class="flex items-center gap-3 mb-10 opacity-80 hover:opacity-100 transition-opacity cursor-pointer"
                onclick="window.location.href='../index.html'">
                <img src="../assets/images/logo.png" alt="LOGO" class="h-6 brightness-0 invert">
                <span
                    class="bg-brandPurple text-white text-[9px] font-black px-1.5 py-0.5 rounded uppercase tracking-widest">Admin</span>
            </div>

            <nav class="space-y-2">
                <a href="admin_dashboard.html"
                    class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-xl bg-brandPurple/20 text-white border border-brandPurple/20 shadow-lg shadow-brandPurple/10"
                    data-page="dashboard">
                    <span class="material-symbols-outlined text-brandPurple">space_dashboard</span>
                    <span class="text-xs font-bold uppercase tracking-wider">Dashboard</span>
                </a>
                <a href="admin_clientes.html"
                    class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white transition-colors"
                    data-page="clientes">
                    <span class="material-symbols-outlined">group</span>
                    <span class="text-xs font-bold uppercase tracking-wider">Clientes</span>
                </a>
                <a href="admin_logistica.html"
                    class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white transition-colors"
                    data-page="logistica">
                    <span class="material-symbols-outlined">inventory_2</span>
                    <span class="text-xs font-bold uppercase tracking-wider">Tu Trastero Inteligente</span>
                </a>

                <div class="pt-4 pb-2 px-4">
                    <p class="text-[9px] font-black text-slate-500 uppercase tracking-[0.2em]">Recursos</p>
                </div>
                <a href="admin_logistica.html?page=conductores"
                    class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white transition-all"
                    data-page="conductores">
                    <span class="material-symbols-outlined">engineering</span>
                    <span class="text-xs font-bold uppercase tracking-wider">Conductores</span>
                </a>
                <a href="admin_logistica.html?page=vehiculos"
                    class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white transition-all"
                    data-page="vehiculos">
                    <span class="material-symbols-outlined">local_shipping</span>
                    <span class="text-xs font-bold uppercase tracking-wider">Veh√≠culos</span>
                </a>

                <a href="admin_facturacion.html"
                    class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white transition-colors"
                    data-page="facturacion">
                    <span class="material-symbols-outlined">payments</span>
                    <span class="text-xs font-bold uppercase tracking-wider">Facturaci√≥n</span>
                </a>
                <a href="admin_ajustes.html"
                    class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white transition-colors"
                    data-page="ajustes">
                    <span class="material-symbols-outlined">settings</span>
                    <span class="text-xs font-bold uppercase tracking-wider">Ajustes</span>
                </a>

                <a href="driver_dashboard.html" target="_blank"
                    class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white transition-all">
                    <span class="material-symbols-outlined">directions_car</span>
                    <span class="text-xs font-bold uppercase tracking-wider">Vista Conductor</span>
                    <span class="material-symbols-outlined text-[10px] ml-auto">open_in_new</span>
                </a>
            </nav>
        </div>

        <div class="px-4 py-3 bg-brandPurple/10 rounded-xl border border-brandPurple/20 cursor-pointer hover:bg-red-500/10 hover:border-red-500/20 transition-all group"
            id="sidebar-user-card" onclick="handleLogout()">
            <p class="text-[10px] text-brandPurple font-black uppercase tracking-widest mb-1 group-hover:text-red-400">
                Cerrar Sesi√≥n</p>
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-green-500 group-hover:bg-red-500"></div>
                <span class="text-xs font-bold text-white group-hover:text-red-400"
                    id="sidebar-admin-name">Cargando...</span>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto bg-[#0a0a0a] p-8">

        <!-- Header -->
        <header class="flex justify-between items-end mb-10">
            <div>
                <h1 class="text-3xl font-black tracking-tight uppercase italic underline decoration-brandPurple/30">
                    Torre de Control</h1>
                <p class="text-slate-400 text-sm font-medium mt-1 uppercase tracking-widest text-[10px]">Visi√≥n global
                    de operaciones en tiempo real</p>
            </div>
            <div class="flex gap-4">
                <button
                    class="w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center text-slate-400 hover:text-white transition-colors">
                    <span class="material-symbols-outlined">notifications</span>
                </button>
                <div class="flex items-center gap-3 pl-4 border-l border-white/10 cursor-pointer group"
                    onclick="handleLogout()">
                    <div class="text-right">
                        <p class="text-xs font-black text-white group-hover:text-red-400 transition-colors">Cerrar
                            Sesi√≥n</p>
                        <p class="text-[10px] text-slate-500 font-bold uppercase" id="header-admin-role">Superadmin</p>
                    </div>
                    <div id="admin-avatar"
                        class="w-9 h-9 rounded-full bg-gradient-to-br from-brandPurple to-blue-600 flex items-center justify-center text-white font-black uppercase italic">
                        A</div>
                </div>
            </div>
        </header>

        <!-- KPI Grid -->
        <div class="grid grid-cols-4 gap-6 mb-10" id="kpi-container">
            <!-- KPI 1 -->
            <div class="bg-[#141414] border border-white/5 p-5 rounded-2xl relative overflow-hidden group">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <span class="material-symbols-outlined text-4xl">person_add</span>
                </div>
                <p class="text-slate-500 text-[10px] font-black uppercase tracking-widest mb-2">Clientes Totales</p>
                <h3 class="text-3xl font-black text-white kpi-value" id="kpi-clients">0</h3>
                <div class="flex gap-2 mt-2">
                    <span class="text-[10px] text-brandPurple font-bold bg-brandPurple/10 px-1.5 py-0.5 rounded">En el
                        sistema</span>
                </div>
            </div>
            <!-- KPI 2 -->
            <div class="bg-[#141414] border border-white/5 p-5 rounded-2xl relative overflow-hidden group">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <span class="material-symbols-outlined text-4xl">inventory</span>
                </div>
                <p class="text-slate-500 text-[10px] font-black uppercase tracking-widest mb-2">Volumen Almacenado</p>
                <h3 class="text-3xl font-black text-white kpi-value" id="kpi-volume">0 m¬≥</h3>
                <div class="flex gap-2 mt-2">
                    <span
                        class="text-[10px] text-green-500 font-bold bg-green-500/10 px-1.5 py-0.5 rounded">Activo</span>
                </div>
            </div>
            <!-- KPI 3 -->
            <div class="bg-[#141414] border border-white/5 p-5 rounded-2xl relative overflow-hidden group">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <span class="material-symbols-outlined text-4xl">local_shipping</span>
                </div>
                <p class="text-slate-500 text-[10px] font-black uppercase tracking-widest mb-2">Rutas Hoy</p>
                <h3 class="text-3xl font-black text-white kpi-value" id="kpi-routes">0</h3>
                <div class="flex gap-2 mt-2">
                    <span class="text-[10px] text-blue-400 font-bold bg-blue-400/10 px-1.5 py-0.5 rounded"
                        id="label-routes">Sin planificar</span>
                </div>
            </div>
            <!-- KPI 4 -->
            <div class="bg-[#141414] border border-white/5 p-5 rounded-2xl relative overflow-hidden group">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <span class="material-symbols-outlined text-4xl">euro</span>
                </div>
                <p class="text-slate-500 text-[10px] font-black uppercase tracking-widest mb-2">Ingresos (MRR)</p>
                <h3 class="text-3xl font-black text-white kpi-value" id="kpi-mrr">0‚Ç¨</h3>
                <div class="flex gap-2 mt-2">
                    <span class="text-[10px] text-slate-500 font-bold bg-white/5 px-1.5 py-0.5 rounded">Estimaci√≥n
                        mensual</span>
                </div>
            </div>
        </div>

        <!-- Recent Orders Table -->
        <h2 class="text-lg font-black uppercase tracking-wider mb-6 flex items-center gap-3">
            <span class="w-2 h-2 rounded-full bg-brandPurple"></span>
            √öltimas Reservas (Live)
        </h2>

        <div class="bg-[#141414] border border-white/5 rounded-2xl overflow-hidden mb-10">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-white/5 text-[10px] font-black text-slate-400 uppercase tracking-widest">
                        <th class="p-4">Cliente</th>
                        <th class="p-4">Plan / Volumen</th>
                        <th class="p-4">Direcci√≥n</th>
                        <th class="p-4">Fecha Recogida</th>
                        <th class="p-4">Estado</th>
                        <th class="p-4 text-right">Acciones</th>
                    </tr>
                </thead>
                <tbody class="text-sm font-medium text-slate-300 divide-y divide-white/5" id="orders-table-body">
                    <tr>
                        <td colspan="6" class="p-12 text-center">
                            <span class="material-symbols-outlined animate-spin text-brandPurple">sync</span>
                            <p class="text-[10px] font-black uppercase tracking-widest mt-2 text-slate-500">
                                Sincronizando con Supabase...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <!-- Edit Order Modal (Minimal for quick actions) -->
    <div id="editModal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
        <div class="bg-[#1a1a1a] border border-white/10 w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl">
            <h3 class="text-xl font-black mb-6 uppercase tracking-tight flex items-center gap-3 italic">
                <span class="material-symbols-outlined text-brandPurple">edit_calendar</span>
                Gesti√≥n R√°pida
            </h3>

            <div class="space-y-4">
                <div>
                    <label class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest">Estado del
                        Servicio</label>
                    <select id="editStatus"
                        class="w-full bg-white/5 border border-white/10 rounded-xl py-3 px-4 text-white font-bold outline-none focus:border-brandPurple transition-all appearance-none [color-scheme:dark]">
                        <option value="pending_call" class="bg-[#1a1a1a]">Pendiente de Llamada</option>
                        <option value="confirmed" class="bg-[#1a1a1a]">Reserva Confirmada</option>
                        <option value="pending_pickup" class="bg-[#1a1a1a]">En Ruta / Recogida</option>
                        <option value="active" class="bg-[#1a1a1a]">En Almac√©n / Activo</option>
                        <option value="canceled" class="bg-[#1a1a1a]">Cancelado</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest">Fecha
                            Recogida</label>
                        <input type="date" id="editDate"
                            class="w-full bg-white/5 border border-white/10 rounded-xl py-3 px-4 text-white font-bold outline-none focus:border-brandPurple transition-all [color-scheme:dark]">
                    </div>
                    <div>
                        <label
                            class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest">Horario</label>
                        <select id="editSlot"
                            class="w-full bg-white/5 border border-white/10 rounded-xl py-3 px-4 text-white font-bold outline-none focus:border-brandPurple transition-all appearance-none [color-scheme:dark]">
                            <option value="morning">MA√ëANA (09-14h)</option>
                            <option value="afternoon">TARDE (15-20h)</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest">Tipo de
                            Acceso</label>
                        <select id="editAccessType"
                            class="w-full bg-white/5 border border-white/10 rounded-xl py-3 px-4 text-white font-bold outline-none focus:border-brandPurple transition-all appearance-none [color-scheme:dark]">
                            <option value="street" class="bg-[#1a1a1a]">Pie de Calle</option>
                            <option value="elevator" class="bg-[#1a1a1a]">Ascensor / Planta</option>
                            <option value="stairs" class="bg-[#1a1a1a]">Escaleras</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest">Tipo de
                            Recogida</label>
                        <select id="editHeavyLoad"
                            class="w-full bg-white/5 border border-white/10 rounded-xl py-3 px-4 text-white font-bold outline-none focus:border-brandPurple transition-all appearance-none [color-scheme:dark]">
                            <option value="false" class="bg-[#1a1a1a]">Cajas o Enseres</option>
                            <option value="true" class="bg-[#1a1a1a]">Muebles Grandes (+Mozo)</option>
                        </select>
                    </div>
                </div>


                <div>
                    <label class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest">Notas
                        Internas / Instrucciones</label>
                    <textarea id="editNotes" placeholder="Ej: No funciona el interfono, llamar al m√≥vil..."
                        class="w-full bg-white/5 border border-white/10 rounded-xl py-3 px-4 text-white text-xs font-medium outline-none focus:border-brandPurple transition-all min-h-[80px]"></textarea>
                </div>
            </div>

            <div class="flex gap-3 mt-8">
                <button onclick="closeEditModal()"
                    class="flex-1 py-4 rounded-xl bg-white/5 text-[10px] font-black uppercase tracking-widest hover:bg-white/10 transition-all">Cerrar</button>
                <button onclick="saveAdminChanges(event)"
                    class="flex-1 py-4 rounded-xl bg-brandPurple text-white text-[10px] font-black uppercase tracking-widest shadow-lg shadow-brandPurple/20 hover:scale-105 transition-all">Actualizar</button>
            </div>
        </div>
    </div>

    <!-- Supabase SDK & Config -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/supabase-config.js"></script>
    <script src="../assets/js/supabase-client.js"></script>

    <script>
        let currentLeads = [];
        let activeEditId = null;

        document.addEventListener('DOMContentLoaded', () => {
            initDashboard();
        });

        async function initDashboard() {
            if (!window.supabaseClient) {
                console.error("‚ùå Supabase no detectado.");
                return;
            }

            // 1. Auth & Role Verification
            const { data: { session } } = await window.supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }

            const { data: profile } = await window.supabaseClient
                .from('profiles')
                .select('*')
                .eq('id', session.user.id)
                .maybeSingle();

            const role = profile?.role || session.user.user_metadata?.role || 'client';

            // SUPERADMIN BYPASS
            let finalRole = role;
            if (session.user.email === 'israel.madrigal@pluser.es') {
                finalRole = 'admin';
            }

            if (finalRole !== 'admin') {
                window.location.href = 'cliente_dashboard.html';
                return;
            }

            // UI Personalization
            document.getElementById('sidebar-admin-name').innerText = profile?.full_name || session.user.email.split('@')[0];
            document.getElementById('admin-avatar').innerText = (profile?.full_name || 'A').charAt(0);

            // 2. Initial Fetch
            await refreshData();

            // 3. Real-time Updates (PostgreSQL Changes)
            window.supabaseClient
                .channel('admin-live-updates')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'leads_wizard' }, (payload) => {
                    console.log('üîÑ Cambio en Leads detectado:', payload);
                    refreshData();
                    if (payload.eventType === 'INSERT') showToast('Nueva reserva recibida');
                })
                .subscribe();
        }

        async function refreshData() {
            try {
                console.log("üîÑ [Admin] Iniciando refresco de datos...");

                // 1. Fetch TOTAL Leads (Sin filtros para asegurar que vemos todo)
                const { data: leads, error: lError } = await window.supabaseClient
                    .from('leads_wizard')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (lError) throw lError;
                console.log("üì¶ [Admin] Leads recuperados:", leads?.length || 0);

                // 2. Fetch Profiles for KPI
                const { data: profiles, error: pError } = await window.supabaseClient
                    .from('profiles')
                    .select('id, email')
                    .eq('role', 'client');

                if (pError) throw pError;

                // 3. Calcular Total Real de Clientes (Suma de Registrados + Prospectos en Leads)
                const uniqueIdentities = new Set();
                (profiles || []).forEach(p => { if (p.email) uniqueIdentities.add(p.email.toLowerCase()); });
                (leads || []).forEach(l => { if (l.email) uniqueIdentities.add(l.email.toLowerCase()); });

                currentLeads = leads || [];
                updateKPIs(currentLeads, uniqueIdentities.size);
                renderTable(currentLeads);
            } catch (err) {
                console.error("‚ùå [Admin] Error cr√≠tico en refreshData:", err);
                const tableBody = document.getElementById('orders-table-body');
                tableBody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-red-400 font-bold uppercase text-[10px]">Error de conexi√≥n: ${err.message}</td></tr>`;
            }
        }

        function updateKPIs(leads, clientCount) {
            // Count Clients
            document.getElementById('kpi-clients').innerText = clientCount;

            // Stats from Leads
            let totalVol = 0;
            let totalMRR = 0;
            let routesTodayCount = 0;
            const today = new Date().toISOString().split('T')[0];

            leads.forEach(l => {
                // KPIs cuentan todo lo que no sea cancelado
                if (l.status !== 'canceled') {
                    totalVol += parseFloat(l.volume_m3 || 0);
                    totalMRR += parseFloat(l.total_monthly || 0);
                }

                if (l.pickup_date === today && l.status !== 'canceled') {
                    routesTodayCount++;
                }
            });

            document.getElementById('kpi-volume').innerText = `${totalVol.toFixed(1)} m¬≥`;
            document.getElementById('kpi-mrr').innerText = `${Math.round(totalMRR)}‚Ç¨`;
            document.getElementById('kpi-routes').innerText = routesTodayCount;

            const routeLabel = document.getElementById('label-routes');
            routeLabel.innerText = routesTodayCount > 0 ? `${routesTodayCount} activas hoy` : 'Sin planificar';
            routeLabel.className = routesTodayCount > 0
                ? "text-[10px] text-green-400 font-bold bg-green-400/10 px-1.5 py-0.5 rounded"
                : "text-[10px] text-slate-500 font-bold bg-white/5 px-1.5 py-0.5 rounded";
        }

        function renderTable(leads) {
            const tableBody = document.getElementById('orders-table-body');
            if (leads.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="p-20 text-center opacity-40">
                    <span class="material-symbols-outlined text-4xl mb-2">database_off</span>
                    <p class="font-black uppercase tracking-widest text-[10px]">No hay registros en la base de datos</p>
                </td></tr>`;
                return;
            }

            const styles = {
                'pending_call': 'bg-orange-500/10 text-orange-400 border-orange-500/20',
                'confirmed': 'bg-blue-500/10 text-blue-400 border-blue-500/20',
                'pending_pickup': 'bg-brandPurple/10 text-brandPurple border-brandPurple/20',
                'active': 'bg-green-500/10 text-green-500 border-green-500/20',
                'canceled': 'bg-red-500/10 text-red-500 border-red-500/20'
            };

            tableBody.innerHTML = leads.map(l => {
                // Identificar si es consolidado
                const isConsolidated = l.is_consolidation || l.consolidated_with;
                const consolidationBadge = isConsolidated
                    ? `<span class="ml-2 bg-brandPurple text-white text-[7px] px-1.5 py-0.5 rounded-full font-black animate-pulse uppercase tracking-tighter">üì¶ Consolidado</span>`
                    : '';

                return `
                <tr class="hover:bg-white/[0.03] transition-colors group">
                    <td class="p-4">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-white/5 text-slate-400 flex items-center justify-center font-black text-xs italic border border-white/5">
                                ${l.full_name?.charAt(0) || 'U'}
                            </div>
                            <div>
                                <div class="flex items-center">
                                    <p class="text-white font-bold group-hover:text-brandPurple transition-colors">${l.full_name || 'Prospecto'}</p>
                                    ${consolidationBadge}
                                </div>
                                <p class="text-[9px] text-slate-500 font-bold uppercase tracking-tighter">${l.email}</p>
                            </div>
                        </div>
                    </td>
                    <td class="p-4">
                        <span class="block text-white font-black italic uppercase text-[10px]">${l.pack_type || 'Custom'}</span>
                        <span class="text-[9px] text-slate-500 font-bold uppercase tracking-widest">${l.volume_m3 || '0'} m¬≥</span>
                    </td>
                    <td class="p-4 text-slate-400 italic text-[11px] truncate max-w-[150px]">
                        ${l.pickup_address || l.address || '‚Äî'} 
                        <span class="block text-[8px] text-slate-600 font-bold uppercase">${l.pickup_city || l.city || ''}</span>
                    </td>
                    <td class="p-4">
                        <span class="block text-white font-black italic uppercase text-[10px]">${l.pickup_date || l.date || 'A convenir'}</span>
                        <span class="text-[8px] text-slate-500 font-bold uppercase tracking-widest">${l.pickup_slot || '‚Äî'}</span>
                    </td>
                    <td class="p-4">
                        <span class="px-2 py-0.5 rounded-[5px] text-[8px] font-black border ${styles[l.status] || 'border-white/10 text-slate-400'} uppercase tracking-widest">
                            ${l.status?.replace('_', ' ').toUpperCase() || 'N/A'}
                        </span>
                    </td>
                    <td class="p-4 text-right">
                        <button onclick="openEditModal('${l.id}')" class="w-8 h-8 rounded-lg bg-white/5 border border-white/10 text-slate-500 hover:bg-brandPurple hover:text-white transition-all">
                            <span class="material-symbols-outlined text-sm">edit</span>
                        </button>
                    </td>
                </tr>`;
            }).join('');
        }

        let originalHeavyLoad = false;

        function openEditModal(id) {
            activeEditId = id;
            const lead = currentLeads.find(l => l.id === id);
            if (lead) {
                originalHeavyLoad = lead.heavy_load || false; // Guardamos estado original

                document.getElementById('editStatus').value = lead.status || 'pending_call';

                // Formateo robusto de fecha para input type="date"
                const pDate = lead.pickup_date || lead.date;
                if (pDate) {
                    document.getElementById('editDate').value = pDate.split('T')[0].split(' ')[0];
                } else {
                    document.getElementById('editDate').value = '';
                }

                document.getElementById('editSlot').value = lead.pickup_slot || 'morning';
                document.getElementById('editAccessType').value = lead.access_type || 'street';
                document.getElementById('editHeavyLoad').value = (lead.heavy_load === true).toString();

                // Nuevos campos de log√≠stica

                document.getElementById('editNotes').value = lead.admin_notes || '';
            }
            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editModal').classList.add('flex');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
        }

        async function saveAdminChanges(e) {
            if (!activeEditId) return;
            const newStatus = document.getElementById('editStatus').value;
            const newDate = document.getElementById('editDate').value;
            const newSlot = document.getElementById('editSlot').value;
            const heavyLoad = document.getElementById('editHeavyLoad').value === 'true';
            const accessType = document.getElementById('editAccessType').value;
            const adminNotes = document.getElementById('editNotes').value;

            const btn = e.currentTarget;
            btn.innerText = "Guardando...";
            btn.disabled = true;

            try {
                // 1. L√≥gica de Cargo Autom√°tico si se a√±ade Mozo
                if (!originalHeavyLoad && heavyLoad) {
                    const doCharge = confirm("‚ö†Ô∏è Has a√±adido servicio de Mozo Extra.\n\n¬øQuieres cobrar autom√°ticamente los 35‚Ç¨ al cliente ahora?");
                    if (doCharge) {
                        // Aqu√≠ ir√≠a la llamada real a la API de cobros (Stripe/Supabase)
                        // await window.supabaseClient.functions.invoke('charge-customer', { amount: 35, concept: 'Mozo Extra' })
                        alert("üí∏ Cobro de 35.00‚Ç¨ procesado correctamente.");
                    }
                }

                // 2. Guardar cambios en DB
                const { error } = await window.supabaseClient
                    .from('leads_wizard')
                    .update({
                        status: newStatus,
                        pickup_date: newDate || null,
                        pickup_slot: newSlot,
                        heavy_load: heavyLoad,
                        access_type: accessType,
                        admin_notes: adminNotes
                    })
                    .eq('id', activeEditId);

                if (error) throw error;
                closeEditModal();
                showToast("Estado actualizado");
                refreshData();
            } catch (err) {
                alert("Error: " + err.message);
            } finally {
                btn.innerText = "Actualizar";
                btn.disabled = false;
            }
        }

        function handleLogout() {
            window.supabaseClient.auth.signOut().then(() => window.location.href = 'login.html');
        }

        // Cerrar modal al hacer clic fuera
        window.addEventListener('click', function (event) {
            const modal = document.getElementById('editModal');
            if (event.target === modal) closeEditModal();
        });

        function showToast(msg) {
            const t = document.createElement('div');
            t.className = "fixed top-6 left-1/2 -translate-x-1/2 bg-brandPurple text-white px-6 py-3 rounded-full shadow-2xl z-[300] font-black uppercase text-[10px] tracking-widest animate-bounce";
            t.innerText = `‚ö†Ô∏è ${msg}`;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 4000);
        }
    </script>
</body>

</html>