<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ajustes | BOXROOMER Admin</title>

    <link
        href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&family=Outfit:wght@300;400;500;700;900&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../assets/js/tailwind.config.js"></script>

    <style>
        body {
            font-family: 'Outfit', sans-serif;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
    </style>
    <script src="../assets/js/reset.js"></script>
</head>

<body class="bg-brandDark text-white h-screen overflow-hidden flex">

    <!-- Sidebar -->
    <aside
        class="w-64 bg-[#111] border-r border-white/5 flex flex-col justify-between p-6 shrink-0 overflow-y-auto scrollbar-hide">
        <div class="pb-8">
            <div
                class="flex items-center gap-3 mb-10 opacity-80 hover:opacity-100 transition-opacity cursor-pointer text-white">
                <img src="../assets/images/logo.png" alt="LOGO" class="h-6 brightness-0 invert">
                <span
                    class="bg-brandPurple text-white text-[9px] font-black px-1.5 py-0.5 rounded uppercase tracking-widest">Admin</span>
            </div>

            <nav class="space-y-2">
                <a href="admin_dashboard"
                    class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white transition-all">
                    <span class="material-symbols-outlined">space_dashboard</span>
                    <span class="text-xs font-bold uppercase tracking-wider">Dashboard</span>
                </a>
                <a href="admin_clientes"
                    class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white transition-all">
                    <span class="material-symbols-outlined">group</span>
                    <span class="text-xs font-bold uppercase tracking-wider">Clientes</span>
                </a>
                <a href="admin_logistica"
                    class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white transition-all">
                    <span class="material-symbols-outlined">inventory_2</span>
                    <span class="text-xs font-bold uppercase tracking-wider">Tu Trastero Inteligente</span>
                </a>

                <div class="pt-4 pb-2 px-4">
                    <p class="text-[9px] font-black text-slate-500 uppercase tracking-[0.2em]">Recursos</p>
                </div>
                <a href="admin_logistica?page=conductores"
                    class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white transition-all">
                    <span class="material-symbols-outlined">engineering</span>
                    <span class="text-xs font-bold uppercase tracking-wider">Conductores</span>
                </a>
                <a href="admin_logistica?page=vehiculos"
                    class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white transition-all">
                    <span class="material-symbols-outlined">local_shipping</span>
                    <span class="text-xs font-bold uppercase tracking-wider">Veh√≠culos</span>
                </a>

                <a href="admin_facturacion"
                    class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white transition-all">
                    <span class="material-symbols-outlined">payments</span>
                    <span class="text-xs font-bold uppercase tracking-wider">Facturaci√≥n</span>
                </a>
                <a href="admin_ajustes"
                    class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-xl bg-brandPurple text-white border border-brandPurple/20 shadow-lg shadow-brandPurple/10 transition-all font-bold">
                    <span class="material-symbols-outlined">settings</span>
                    <span class="text-xs font-bold uppercase tracking-wider">Ajustes</span>
                </a>

                <a href="driver_dashboard.html" target="_blank"
                    class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-white/5 hover:text-white transition-all">
                    <span class="material-symbols-outlined">directions_car</span>
                    <span class="text-xs font-bold uppercase tracking-wider">Vista Conductor</span>
                    <span class="material-symbols-outlined text-[10px] ml-auto">open_in_new</span>
                </a>
            </nav>
        </div>

        <div class="px-4 py-3 bg-brandPurple/10 rounded-xl border border-brandPurple/20 cursor-pointer hover:bg-red-500/10 hover:border-red-500/20 transition-all group"
            onclick="handleLogout()">
            <p class="text-[10px] text-brandPurple font-black uppercase tracking-widest mb-1 group-hover:text-red-400">
                Cerrar Sesi√≥n</p>
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-green-500 group-hover:bg-red-500"></div>
                <span class="text-xs font-bold text-white group-hover:text-red-400">Israel Madrigal</span>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto bg-[#0a0a0a] p-8 scrollbar-hide">
        <header class="flex justify-between items-end mb-10">
            <div>
                <h1 class="text-3xl font-black italic tracking-tighter uppercase">Configuraci√≥n de Negocio</h1>
                <p class="text-slate-400 text-sm font-medium mt-1">Gesti√≥n de tarifas, packs de suscripci√≥n y
                    estrategias de cupones</p>
            </div>
        </header>

        <div class="space-y-12 pb-20">
            <!-- Secci√≥n: Gesti√≥n de Precios y Packs -->
            <section>
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-500">Tarifas y Packs
                        (Suscripciones)</h3>
                    <button onclick="openPackModal()"
                        class="bg-white/5 border border-white/10 px-4 py-2 rounded-xl text-[10px] font-black uppercase hover:bg-white hover:text-brandDark transition-all">+
                        Crear Nuevo Pack</button>
                </div>
                <div class="bg-[#141414] border border-white/5 rounded-[2rem] overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-white/5">
                            <tr class="text-[9px] font-black text-slate-500 uppercase tracking-widest leading-none">
                                <th class="px-6 py-5">Nombre del Pack</th>
                                <th class="px-6 py-5">Volumen M√°x.</th>
                                <th class="px-6 py-5">Precio Mes</th>
                                <th class="px-6 py-5">Permanencia</th>
                                <th class="px-6 py-5">Cajas Incl.</th>
                                <th class="px-6 py-5 text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="packs-table-body"
                            class="divide-y divide-white/5 text-[11px] font-bold text-slate-300">
                            <!-- JS populates -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Secci√≥n: Cupones de Descuento -->
            <section>
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-500">Estrategia de Cupones
                    </h3>
                    <button onclick="openCouponModal()"
                        class="bg-brandPurple text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase shadow-lg shadow-brandPurple/20 hover:scale-105 transition-all">+
                        Crear Cup√≥n</button>
                </div>
                <div id="coupons-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- JS populates -->
                </div>
            </section>

            <!-- Secci√≥n: Tramos de Seguros (Protecci√≥n) -->
            <section>
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-500">Configuraci√≥n de Seguro
                        (Protecci√≥n de Bienes)</h3>
                    <button onclick="openInsuranceModal()"
                        class="bg-white/5 border border-white/10 px-4 py-2 rounded-xl text-[10px] font-black uppercase hover:bg-white hover:text-brandDark transition-all">+
                        A√±adir Tramo</button>
                </div>
                <div class="bg-[#141414] border border-white/5 rounded-[2rem] overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-white/5">
                            <tr class="text-[9px] font-black text-slate-500 uppercase tracking-widest leading-none">
                                <th class="px-6 py-5 whitespace-nowrap">Cobertura M√°x.</th>
                                <th class="px-6 py-5">Tipo de Seguro</th>
                                <th class="px-6 py-5">Coste Mensual</th>
                                <th class="px-6 py-5">Popularidad</th>
                                <th class="px-6 py-5 text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="insurance-table-body"
                            class="divide-y divide-white/5 text-[11px] font-bold text-slate-300">
                            <!-- JS fills -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Secci√≥n: Auditor√≠a de Cambios (Trazabilidad) -->
            <section>
                <div class="flex items-center gap-3 mb-6">
                    <h3 class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-500">Trazabilidad (Audit
                        Log)</h3>
                    <span class="w-1.5 h-1.5 rounded-full bg-orange-500"></span>
                </div>
                <div class="bg-[#141414] border border-white/5 rounded-[2rem] overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-white/5">
                            <tr class="text-[9px] font-black text-slate-500 uppercase tracking-widest leading-none">
                                <th class="px-6 py-5">Timestamp</th>
                                <th class="px-6 py-5">Acci√≥n</th>
                                <th class="px-6 py-5">Admin</th>
                                <th class="px-6 py-5">Detalle/Origen</th>
                                <th class="px-6 py-5 text-right">Nivel</th>
                            </tr>
                        </thead>
                        <tbody id="audit-table-body"
                            class="divide-y divide-white/5 text-[10px] font-medium text-slate-400">
                            <!-- JS fills -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Danger Zone: Demo Reset -->
            <section class="mt-12 pt-12 border-t border-white/5">
                <div class="flex justify-between items-center bg-red-500/5 border border-red-500/20 p-6 rounded-[2rem]">
                    <div>
                        <h4 class="text-white font-black uppercase text-sm italic tracking-tighter">Zona de Peligro</h4>
                        <p class="text-[10px] text-slate-400 mt-1">Acciones destructivas para el entorno de
                            demostraci√≥n.</p>
                    </div>
                    <button onclick="resetDemoData()"
                        class="bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white border border-red-500/30 px-6 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all">
                        Resetear Datos Demo
                    </button>
                </div>
            </section>
        </div>
    </main>

    <!-- Modal: Pack Editor -->
    <div id="packModal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
        <div class="bg-[#1a1a1a] border border-white/10 w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl">
            <h3 id="pack-modal-title" class="text-xl font-black mb-6 uppercase tracking-tight italic">Crear Nuevo Pack
            </h3>
            <div class="space-y-4">
                <div>
                    <label
                        class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest">Nombre</label>
                    <input type="text" id="pack-name"
                        class="w-full bg-white/5 border border-white/10 rounded-xl py-3 px-4 text-white text-xs outline-none focus:border-brandPurple">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest">Volumen
                            (m¬≥)</label>
                        <input type="text" id="pack-volume"
                            class="w-full bg-white/5 border border-white/10 rounded-xl py-3 px-4 text-white text-xs outline-none focus:border-brandPurple">
                    </div>
                    <div>
                        <label
                            class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest">Cajas</label>
                        <input type="number" id="pack-boxes"
                            class="w-full bg-white/5 border border-white/10 rounded-xl py-3 px-4 text-white text-xs outline-none focus:border-brandPurple">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest">Precio
                            (‚Ç¨/mes)</label>
                        <input type="number" id="pack-price"
                            class="w-full bg-white/5 border border-white/10 rounded-xl py-3 px-4 text-white text-xs outline-none focus:border-brandPurple">
                    </div>
                    <div>
                        <label
                            class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest">Permanencia</label>
                        <select id="pack-permanence"
                            class="w-full bg-[#1A1A1A] border border-white/10 rounded-xl py-3 px-4 text-white text-xs outline-none focus:border-brandPurple">
                            <option value="Sin Permanencia">Sin Permanencia</option>
                            <option value="3 Meses">3 Meses</option>
                            <option value="6 Meses">6 Meses</option>
                            <option value="12 Meses">12 Meses</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button onclick="closePackModal()"
                    class="flex-1 py-4 rounded-xl bg-white/5 text-[10px] font-black uppercase tracking-widest">Cancelar</button>
                <button onclick="savePack()"
                    class="flex-1 py-4 rounded-xl bg-brandPurple text-white text-[10px] font-black uppercase tracking-widest shadow-lg shadow-brandPurple/20">Guardar
                    Pack</button>
            </div>
        </div>
    </div>

    <!-- Modal: Coupon Editor -->
    <div id="couponModal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
        <div class="bg-[#1a1a1a] border border-white/10 w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl">
            <h3 id="coupon-modal-title" class="text-xl font-black mb-6 uppercase tracking-tight italic">Nuevo Cup√≥n</h3>
            <div class="space-y-4">
                <div>
                    <label
                        class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest">C√≥digo</label>
                    <input type="text" id="coupon-code" placeholder="EJ: DESCUENTO50"
                        class="w-full bg-white/5 border border-white/10 rounded-xl py-3 px-4 text-white text-xs font-black uppercase outline-none focus:border-brandPurple">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label
                            class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest">Descuento</label>
                        <div class="relative">
                            <input type="text" id="coupon-value" placeholder="25"
                                class="w-full bg-white/5 border border-white/10 rounded-xl py-3 px-4 text-white text-xs outline-none focus:border-brandPurple">
                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 font-bold text-xs">% /
                                ‚Ç¨</span>
                        </div>
                    </div>
                    <div>
                        <label
                            class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest">Estado</label>
                        <select id="coupon-status"
                            class="w-full bg-[#1A1A1A] border border-white/10 rounded-xl py-3 px-4 text-white text-xs outline-none focus:border-brandPurple">
                            <option value="Activo">Activo</option>
                            <option value="Expirado">Expirado</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label
                        class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest">Descripci√≥n</label>
                    <input type="text" id="coupon-desc" placeholder="Dto. primer mes"
                        class="w-full bg-white/5 border border-white/10 rounded-xl py-3 px-4 text-white text-xs outline-none focus:border-brandPurple">
                </div>
                <div>
                    <label class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest">Fecha
                        Expiraci√≥n (Opcional)</label>
                    <input type="date" id="coupon-expiry"
                        class="w-full bg-white/5 border border-white/10 rounded-xl py-3 px-4 text-white text-xs outline-none focus:border-brandPurple [color-scheme:dark]">
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button onclick="closeCouponModal()"
                    class="flex-1 py-4 rounded-xl bg-white/5 text-[10px] font-black uppercase tracking-widest">Cancelar</button>
                <button onclick="saveCoupon()"
                    class="flex-1 py-4 rounded-xl bg-brandPurple text-white text-[10px] font-black uppercase tracking-widest shadow-lg shadow-brandPurple/20">Guardar
                    Cup√≥n</button>
            </div>
        </div>
    </div>

    <!-- Modal: Confirmaci√≥n Bonito -->
    <div id="insuranceModal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
        <div class="bg-[#1a1a1a] border border-white/10 w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl">
            <h3 id="insurance-modal-title"
                class="text-xl font-black mb-6 uppercase tracking-tight italic text-white flex items-center gap-3">
                <span class="material-symbols-outlined text-brandPurple">shield</span>
                Configurar Seguro
            </h3>
            <div class="space-y-4">
                <div>
                    <label class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest">Cobertura
                        M√°xima (‚Ç¨)</label>
                    <input type="number" id="ins-coverage" placeholder="500"
                        class="w-full bg-white/5 border border-white/10 rounded-xl py-3 px-4 text-white text-xs outline-none focus:border-brandPurple font-bold">
                </div>
                <div>
                    <label class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest">Coste
                        Mensual (‚Ç¨)</label>
                    <input type="number" id="ins-cost" placeholder="0"
                        class="w-full bg-white/5 border border-white/10 rounded-xl py-3 px-4 text-white text-xs outline-none focus:border-brandPurple font-bold">
                </div>
                <div>
                    <label class="text-[9px] font-black uppercase text-slate-500 mb-2 block tracking-widest">Etiqueta /
                        Popularidad</label>
                    <select id="ins-label"
                        class="w-full bg-[#1A1A1A] border border-white/10 rounded-xl py-3 px-4 text-white text-xs outline-none focus:border-brandPurple">
                        <option value="estandar">Est√°ndar</option>
                        <option value="popular">M√°s Popular</option>
                        <option value="premium">Premium / Recomendado</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button onclick="closeInsuranceModal()"
                    class="flex-1 py-4 rounded-xl bg-white/5 text-[10px] font-black uppercase tracking-widest text-slate-400">Cancelar</button>
                <button onclick="saveInsurance()"
                    class="flex-1 py-4 rounded-xl bg-brandPurple text-white text-[10px] font-black uppercase tracking-widest shadow-lg shadow-brandPurple/20">Guardar
                    Tramo</button>
            </div>
        </div>
    </div>

    <!-- Modal: Confirmaci√≥n Bonito -->
    <div id="confirmModal"
        class="fixed inset-0 bg-black/90 backdrop-blur-md z-[200] hidden items-center justify-center p-4">
        <div class="bg-[#1a1a1a] border border-white/10 w-full max-w-sm rounded-[2.5rem] p-10 text-center shadow-2xl">
            <div
                class="w-20 h-20 bg-red-500/10 text-red-500 rounded-full flex items-center justify-center mx-auto mb-6">
                <span class="material-symbols-outlined text-4xl">warning</span>
            </div>
            <h3 class="text-xl font-black text-white italic uppercase tracking-tighter mb-2">¬øEst√°s seguro?</h3>
            <p class="text-xs text-slate-500 font-bold uppercase tracking-widest leading-relaxed mb-8">Esta acci√≥n es
                irreversible y afectar√° a la operativa de negocio.</p>
            <div class="flex gap-3">
                <button onclick="closeConfirmModal()"
                    class="flex-1 py-4 rounded-xl bg-white/5 text-[10px] font-black uppercase tracking-widest text-white">Cancelar</button>
                <button id="confirm-action-btn"
                    class="flex-1 py-4 rounded-xl bg-red-500 text-white text-[10px] font-black uppercase tracking-widest shadow-lg shadow-red-500/20">S√≠,
                    Borrar</button>
            </div>
        </div>
    </div>

    <!-- Supabase SDK & Config -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/supabase-config.js"></script>
    <script src="../assets/js/supabase-client.js"></script>

    <script>
        let packs = [];
        let coupons = [];
        let insuranceTiers = [];

        document.addEventListener('DOMContentLoaded', () => {
            initSettings();
        });

        async function initSettings() {
            if (!window.supabaseClient) {
                console.warn("‚ö†Ô∏è [Admin] Supabase not initialized. Using defaults.");
                packs = DEFAULT_PACKS;
                insuranceTiers = DEFAULT_INSURANCE;
                renderAll();
                return;
            }

            // Auth Check
            const { data: { session } } = await window.supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }

            const { data: profile } = await window.supabaseClient
                .from('profiles')
                .select('role')
                .eq('id', session.user.id)
                .maybeSingle();

            const role = profile?.role || session.user.user_metadata?.role || 'client';

            // ü¶∏‚Äç‚ôÇÔ∏è SUPERADMIN BYPASS
            let finalRole = role;
            if (session.user.email === 'israel.madrigal@pluser.es') {
                finalRole = 'admin';
                console.log("üëë [Auth] Superadmin detectado por email en Ajustes.");
            }

            if (finalRole !== 'admin') {
                console.warn("‚õî Acceso denegado: Solo administradores.");
                window.location.href = 'cliente_dashboard.html';
                return;
            }

            try {
                const { data, error } = await window.supabaseClient
                    .from('box_settings')
                    .select('*');

                if (error) throw error;

                // Map data to local variables
                const settings = {};
                data.forEach(item => { settings[item.key] = item.value; });

                packs = settings.packs || DEFAULT_PACKS;
                insuranceTiers = settings.insurance || DEFAULT_INSURANCE;
                coupons = settings.coupons || [];

                renderAll();
            } catch (err) {
                console.error("‚ùå Error loading settings:", err);
            }
        }

        function renderAll() {
            renderPacks();
            renderInsurance();
            renderCoupons();
            renderAuditLog();
        }

        async function saveToStorage(key, value) {
            // Local sync
            if (key === 'packs') packs = value;
            if (key === 'insurance') insuranceTiers = value;
            if (key === 'coupons') coupons = value;

            if (!window.supabaseClient) {
                localStorage.setItem(`BOXROOMER_${key.toUpperCase()}`, JSON.stringify(value));
                return;
            }

            try {
                const { error } = await window.supabaseClient
                    .from('box_settings')
                    .upsert({ key: key, value: value, updated_at: new Date().toISOString() });

                if (error) throw error;
                console.log(`‚úÖ [Admin] Saved ${key} to Supabase`);
            } catch (err) {
                alert("Error al guardar en base de datos: " + err.message);
            }
        }

        // Factory Defaults
        const DEFAULT_PACKS = [
            // --- PACS DE SUSCRIPCI√ìN (Referencia: reserva.js -> PRICES constants + User Specs) ---
            // Pack Mini (1.0m¬≥): 139‚Ç¨ (3m), 199‚Ç¨ (6m), 319‚Ç¨ (12m)
            {
                id: 1,
                name: 'Pack Mini',
                volume: '1.0 m¬≥',
                price: 26.60,
                permanence: 'variable',
                boxes: 0,
                extra: false,
                price3: 139,
                price6: 199,
                price12: 319,
                info: 'Recogida y Entrega GRATIS (+15min cortes√≠a), Seguro 1000‚Ç¨/m¬≥, App.'
            },
            // Pack D√∫o (2.0m¬≥): 199‚Ç¨ (3m), 309‚Ç¨ (6m), 529‚Ç¨ (12m)
            {
                id: 2,
                name: 'Pack D√∫o',
                volume: '2.0 m¬≥',
                price: 44.10,
                permanence: 'variable',
                boxes: 0,
                extra: false,
                price3: 199,
                price6: 309,
                price12: 529,
                info: 'Recogida y Entrega GRATIS (+15min cortes√≠a), Seguro, App.'
            },

            // --- TARIFAS VARIABLES (Referencia: reserva.js -> BASE_M1 / ADDITIONAL_M2) ---
            { id: 10, name: 'Precio Base (1er m¬≥)', volume: 'Base', price: 39.00, permanence: '‚Äî', boxes: '‚Äî', extra: true, unit: '‚Ç¨/m¬≥', info: 'Precio del primer metro c√∫bico (C√°lculo Manual)' },
            { id: 11, name: 'Precio m¬≥ Adicional', volume: 'Extra', price: 16.00, permanence: '‚Äî', boxes: '‚Äî', extra: true, unit: '‚Ç¨/m¬≥', info: 'Por cada m¬≥ adicional al primero (C√°lculo Manual)' },

            // --- LOG√çSTICA Y EXTRAS (Referencia: calculo manual) ---
            // Recogida es GRATIS en packs. Devoluci√≥n (Entrega posterior) se cobra como transporte si no est√° incluida en promo.
            { id: 5, name: 'Devoluci√≥n / Transporte', volume: 'Zona 0', price: 39.00, permanence: '‚Äî', boxes: '‚Äî', extra: true, unit: '‚Ç¨/viaje', info: 'Coste de entrega desde almac√©n a cliente (Zona 0)' },

            // "Mozo Extra"
            { id: 6, name: 'Mozo Adicional (Ayuda)', volume: 'Carga', price: 35.00, permanence: '‚Äî', boxes: '‚Äî', extra: true, unit: '‚Ç¨/viaje', info: 'Suplemento por carga pesada (ayuda extra)' },

            // "Cajas"
            { id: 7, name: 'Caja BOXROOMER (L)', volume: 'Venta', price: 1.80, permanence: '‚Äî', boxes: '‚Äî', extra: true, unit: '‚Ç¨/ud', info: 'Precio unitario de venta de caja' },

            // --- OTROS SUPLEMENTOS ---
            { id: 20, name: 'Tiempo Extra (15min)', volume: 'Bloque', price: 15.00, permanence: '‚Äî', boxes: '‚Äî', extra: true, unit: '‚Ç¨/15m', info: 'Exceso de tiempo en carga/descarga' },
            { id: 4, name: 'Gesti√≥n / Cancelaci√≥n', volume: 'Admin', price: 39.00, permanence: '‚Äî', boxes: '‚Äî', extra: true, unit: '‚Ç¨/caso', info: 'Cargo administrativo' }
        ];

        // Seguros: En reserva.js no hay selecci√≥n de seguro con precio.
        // Seguros incluidos en el pack ("Seguro a Todo Riesgo" mencionado en chat pero sin coste extra visible).
        // Dejamos estructura vac√≠a o b√°sica gratutita por si acaso, pero sin costes extra "inventados".
        const DEFAULT_INSURANCE = [
            { id: 1, coverage: 500, cost: 0, label: 'Protecci√≥n B√°sica', popular: true }
        ];

        // State (Loaded from LS or Defaults)
        // COUPONS: Default to empty if nothing in LS (Clean Slate)
        let packs = loadData('BOXROOMER_PACKS', DEFAULT_PACKS);
        let coupons = loadData('BOXROOMER_COUPONS', []);
        let insuranceTiers = loadData('BOXROOMER_INSURANCE_TIERS', DEFAULT_INSURANCE);

        let currentEditingId = null;
        let deleteCallback = null;

        // Persist Helpers
        function saveToStorage() {
            localStorage.setItem('BOXROOMER_PACKS', JSON.stringify(packs));
            localStorage.setItem('BOXROOMER_COUPONS', JSON.stringify(coupons));
            localStorage.setItem('BOXROOMER_INSURANCE_TIERS', JSON.stringify(insuranceTiers));
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderPacks();
            renderCoupons();
            renderInsurance();
            renderAuditLog();
        });

        function renderAuditLog() {
            const logs = JSON.parse(localStorage.getItem('BOXROOMER_AUDIT_LOG') || '[]');
            const table = document.getElementById('audit-table-body');
            table.innerHTML = logs.map(log => `
                <tr class="hover:bg-white/[0.02]">
                    <td class="px-6 py-4">${new Date(log.timestamp).toLocaleString()}</td>
                    <td class="px-6 py-4 font-black uppercase text-brandPurple">${log.action}</td>
                    <td class="px-6 py-4 italic">${log.admin}</td>
                    <td class="px-6 py-4">${log.details} <span class="text-slate-600 ml-2">(${log.origin})</span></td>
                    <td class="px-6 py-4 text-right">
                        <span class="px-1.5 py-0.5 rounded text-[8px] font-black border ${log.level === 'ALTA' ? 'border-red-500/40 text-red-500' : 'border-blue-500/40 text-blue-500'}">${log.level}</span>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="5" class="p-6 text-center text-slate-600 italic uppercase">No hay actividad registrada recientemente</td></tr>';
        }

        function addAuditLog(action, details, level, target, origin) {
            const logs = JSON.parse(localStorage.getItem('BOXROOMER_AUDIT_LOG') || '[]');
            logs.unshift({
                timestamp: new Date().toISOString(),
                action,
                details,
                level,
                target,
                origin,
                admin: 'Admin Principal'
            });
            localStorage.setItem('BOXROOMER_AUDIT_LOG', JSON.stringify(logs.slice(0, 100)));
            renderAuditLog();
        }

        function renderInsurance() {
            const table = document.getElementById('insurance-table-body');
            if (!table) return;
            table.innerHTML = insuranceTiers.map(tier => `
                <tr class="hover:bg-white/[0.02] transition-all group">
                    <td class="px-6 py-5 whitespace-nowrap">
                        <span class="text-white font-black italic uppercase tracking-tighter">Hasta ${tier.coverage}‚Ç¨</span>
                    </td>
                    <td class="px-6 py-5 text-[10px] text-slate-400 uppercase tracking-widest font-black">${tier.label}</td>
                    <td class="px-6 py-5 text-brandPurple font-black italic">${tier.cost === 0 ? 'GRATIS' : tier.cost.toFixed(2) + '‚Ç¨'}</td>
                    <td class="px-6 py-5">
                        <span class="px-2 py-0.5 rounded text-[8px] font-black uppercase ${tier.popular ? 'bg-orange-500/10 text-orange-500 border border-orange-500/20' : 'bg-white/5 text-slate-500'}">
                            ${tier.popular ? 'M√°s Popular' : 'Est√°ndar'}
                        </span>
                    </td>
                    <td class="px-6 py-5 text-right">
                        <div class="flex justify-end gap-2">
                            <button onclick="editInsurance(${tier.id})" class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center hover:bg-brandPurple hover:text-white transition-all text-slate-500">
                                <span class="material-symbols-outlined text-sm">tune</span>
                            </button>
                            <button onclick="confirmDelete(() => deleteInsurance(${tier.id}))" class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center hover:bg-red-500 hover:text-white transition-all text-slate-500">
                                <span class="material-symbols-outlined text-sm">delete</span>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function openInsuranceModal() {
            currentEditingId = null;
            document.getElementById('insurance-modal-title').innerHTML = '<span class="material-symbols-outlined text-brandPurple">shield</span> Configurar Seguro';
            document.getElementById('ins-coverage').value = '';
            document.getElementById('ins-cost').value = '';
            document.getElementById('insuranceModal').classList.remove('hidden');
            document.getElementById('insuranceModal').classList.add('flex');
        }

        function closeInsuranceModal() {
            document.getElementById('insuranceModal').classList.add('hidden');
            document.getElementById('insuranceModal').classList.remove('flex');
        }

        function saveInsurance() {
            const coverage = parseInt(document.getElementById('ins-coverage').value);
            const cost = parseFloat(document.getElementById('ins-cost').value);
            const labelValue = document.getElementById('ins-label').value;

            const labelsMap = {
                'estandar': 'Protecci√≥n Est√°ndar',
                'popular': 'Favorito del Cliente',
                'premium': 'M√°xima Cobertura'
            };

            if (currentEditingId) {
                const tier = insuranceTiers.find(t => t.id === currentEditingId);
                tier.coverage = coverage;
                tier.cost = cost;
                tier.label = labelsMap[labelValue];
                tier.popular = labelValue === 'popular';
                addAuditLog('EDICION_SEGURO', `Tramo seguro editado: ${coverage}‚Ç¨`, 'MEDIA', currentEditingId, 'AJUSTES');
            } else {
                const id = Date.now();
                insuranceTiers.push({
                    id, coverage, cost,
                    label: labelsMap[labelValue],
                    popular: labelValue === 'popular'
                });
                addAuditLog('CREACION_SEGURO', `Nuevo tramo seguro: ${coverage}‚Ç¨`, 'MEDIA', id, 'AJUSTES');
            }
            saveToStorage('insurance', insuranceTiers);
            renderInsurance();
            closeInsuranceModal();
        }

        function editInsurance(id) {
            currentEditingId = id;
            const tier = insuranceTiers.find(t => t.id === id);
            document.getElementById('insurance-modal-title').innerHTML = '<span class="material-symbols-outlined text-brandPurple">settings</span> Editar Seguro';
            document.getElementById('ins-coverage').value = tier.coverage;
            document.getElementById('ins-cost').value = tier.cost;
            document.getElementById('insuranceModal').classList.remove('hidden');
            document.getElementById('insuranceModal').classList.add('flex');
        }

        function deleteInsurance(id) {
            const tier = insuranceTiers.find(t => t.id === id);
            addAuditLog('BORRADO_SEGURO', `Tramo seguro eliminado: ${tier?.coverage}‚Ç¨`, 'ALTA', id, 'AJUSTES');
            insuranceTiers = insuranceTiers.filter(t => t.id !== id);
            saveToStorage('insurance', insuranceTiers);
            renderInsurance();
            closeConfirmModal();
        }

        function renderPacks() {
            const table = document.getElementById('packs-table-body');
            table.innerHTML = packs.map(pack => `
                <tr class="hover:bg-white/[0.02] transition-all group">
                    <td class="px-6 py-5">
                        <span class="text-white font-black italic uppercase tracking-tighter">${pack.name}</span>
                        ${pack.extra ? '<span class="ml-2 bg-blue-500/10 text-blue-400 text-[7px] px-1.5 py-0.5 rounded leading-none">VAR</span>' : ''}
                    </td>
                    <td class="px-6 py-5">${pack.volume}</td>
                    <td class="px-6 py-5 text-brandPurple font-bold text-sm">
                        ${pack.price3 ?
                    `<div class="flex flex-col gap-0.5">
                                <span class="whitespace-nowrap"><span class="text-white/40 text-[10px]">3m:</span> ${pack.price3}‚Ç¨</span>
                                <span class="whitespace-nowrap"><span class="text-white/40 text-[10px]">6m:</span> ${pack.price6}‚Ç¨</span>
                                <span class="whitespace-nowrap"><span class="text-white/40 text-[10px]">12m:</span> ${pack.price12}‚Ç¨</span>
                             </div>`
                    : `${pack.price.toFixed(2)}${pack.unit || '‚Ç¨'}`
                }
                    </td>
                    <td class="px-6 py-5">${pack.permanence}</td>
                    <td class="px-6 py-5">${pack.boxes}</td>
                    <td class="px-6 py-5 text-right flex justify-end gap-2">
                        <button onclick="editPack(${pack.id})" class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center hover:bg-brandPurple hover:text-white transition-all">
                            <span class="material-symbols-outlined text-sm">edit</span>
                        </button>
                        <button onclick="confirmDelete(() => deletePack(${pack.id}))" class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center hover:bg-red-500 hover:text-white transition-all">
                            <span class="material-symbols-outlined text-sm">delete</span>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderCoupons() {
            const grid = document.getElementById('coupons-grid');
            const now = new Date();

            if (!coupons || coupons.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full py-12 flex flex-col items-center justify-center opacity-40 border border-dashed border-white/10 rounded-[2rem]">
                        <span class="material-symbols-outlined text-4xl mb-2 text-slate-500">local_activity</span>
                        <p class="text-xs font-black uppercase tracking-widest text-slate-500">No hay cupones activos</p>
                    </div>
                 `;
                return;
            }

            grid.innerHTML = coupons.map(c => {
                let status = c.status;
                if (c.expiry && new Date(c.expiry) < now) {
                    status = 'Expirado';
                }

                return `
                <div class="bg-[#141414] border border-white/5 p-6 rounded-[2rem] flex items-center gap-6 group hover:border-brandPurple/20 transition-all ${status === 'Expirado' ? 'opacity-60' : ''}">
                    <div class="w-14 h-14 shrink-0 rounded-2xl bg-${status === 'Activo' ? 'brandPurple' : 'white'}/10 text-${status === 'Activo' ? 'brandPurple' : 'slate-500'} flex items-center justify-center text-xl font-black italic">
                        ${c.value}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs font-black text-white uppercase italic tracking-tighter truncate">${c.code}</p>
                        <p class="text-[9px] text-slate-500 font-bold uppercase tracking-widest mt-1 truncate">${c.desc}</p>
                        ${c.expiry ? `<p class="text-[8px] text-red-500 font-black mt-1 uppercase">Vence: ${c.expiry}</p>` : ''}
                    </div>
                    <div class="flex flex-col gap-2 shrink-0">
                        <span class="bg-${status === 'Activo' ? 'green-500' : 'white'}/10 text-${status === 'Activo' ? 'green-500' : 'slate-500'} text-[8px] font-black px-2 py-1 rounded uppercase text-center border border-${status === 'Activo' ? 'green-500' : 'white'}/20">${status}</span>
                        <div class="flex gap-1 justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="editCoupon(${c.id})" class="text-slate-500 hover:text-white transition-colors">
                                <span class="material-symbols-outlined text-sm">edit</span>
                            </button>
                            <button onclick="confirmDelete(() => deleteCoupon(${c.id}))" class="text-slate-500 hover:text-red-500 transition-colors">
                                <span class="material-symbols-outlined text-sm">delete</span>
                            </button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // Pack Functions
        function openPackModal() {
            currentEditingId = null;
            document.getElementById('pack-modal-title').innerText = "Crear Nuevo Pack";
            document.getElementById('pack-name').value = '';
            document.getElementById('pack-volume').value = '';
            document.getElementById('pack-boxes').value = '';
            document.getElementById('pack-price').value = '';
            document.getElementById('packModal').classList.remove('hidden');
            document.getElementById('packModal').classList.add('flex');
        }

        function closePackModal() {
            document.getElementById('packModal').classList.add('hidden');
            document.getElementById('packModal').classList.remove('flex');
        }

        function savePack() {
            const name = document.getElementById('pack-name').value;
            const volume = document.getElementById('pack-volume').value;
            const boxes = document.getElementById('pack-boxes').value;
            const price = parseFloat(document.getElementById('pack-price').value);
            const permanence = document.getElementById('pack-permanence').value;

            if (currentEditingId) {
                const pack = packs.find(p => p.id === currentEditingId);
                pack.name = name;
                pack.volume = volume;
                pack.boxes = boxes;
                pack.price = price;
                pack.permanence = permanence;
            } else {
                packs.push({
                    id: Date.now(),
                    name, volume, boxes, price, permanence, extra: false
                });
            }
            saveToStorage('packs', packs);
            renderPacks();
            closePackModal();
        }

        function editPack(id) {
            currentEditingId = id;
            const pack = packs.find(p => p.id === id);
            document.getElementById('pack-modal-title').innerText = "Editar Pack";
            document.getElementById('pack-name').value = pack.name;
            document.getElementById('pack-volume').value = pack.volume;
            document.getElementById('pack-boxes').value = pack.boxes;
            document.getElementById('pack-price').value = pack.price;
            document.getElementById('pack-permanence').value = pack.permanence;
            document.getElementById('packModal').classList.remove('hidden');
            document.getElementById('packModal').classList.add('flex');
        }

        function deletePack(id) {
            const pack = packs.find(p => p.id === id);
            addAuditLog('BORRADO_PACK', `Borrado de pack: ${pack.name}`, 'ALTA', id, 'AJUSTES');
            packs = packs.filter(p => p.id !== id);
            saveToStorage('packs', packs);
            renderPacks();
            closeConfirmModal();
        }

        // Coupon Functions
        function openCouponModal() {
            currentEditingId = null;
            document.getElementById('coupon-modal-title').innerText = "Nuevo Cup√≥n";
            document.getElementById('coupon-code').value = '';
            document.getElementById('coupon-value').value = '';
            document.getElementById('coupon-desc').value = '';
            document.getElementById('coupon-expiry').value = '';
            document.getElementById('couponModal').classList.remove('hidden');
            document.getElementById('couponModal').classList.add('flex');
        }

        function closeCouponModal() {
            document.getElementById('couponModal').classList.add('hidden');
            document.getElementById('couponModal').classList.remove('flex');
        }

        function saveCoupon() {
            const code = document.getElementById('coupon-code').value.toUpperCase();
            const value = document.getElementById('coupon-value').value;
            const desc = document.getElementById('coupon-desc').value;
            const status = document.getElementById('coupon-status').value;
            const expiry = document.getElementById('coupon-expiry').value;

            if (currentEditingId) {
                const c = coupons.find(x => x.id === currentEditingId);
                c.code = code;
                c.value = value;
                c.desc = desc;
                c.status = status;
                c.expiry = expiry;
                addAuditLog('EDICION_CUPON', `Editado cup√≥n: ${code}`, 'MEDIA', currentEditingId, 'AJUSTES');
            } else {
                const id = Date.now();
                coupons.push({ id, code, value, desc, status, expiry });
                addAuditLog('CREACION_CUPON', `Nuevo cup√≥n creado: ${code}`, 'MEDIA', id, 'AJUSTES');
            }
            saveToStorage('coupons', coupons);
            renderCoupons();
            closeCouponModal();
        }

        function editCoupon(id) {
            currentEditingId = id;
            const c = coupons.find(x => x.id === id);
            document.getElementById('coupon-modal-title').innerText = "Editar Cup√≥n";
            document.getElementById('coupon-code').value = c.code;
            document.getElementById('coupon-value').value = c.value;
            document.getElementById('coupon-desc').value = c.desc;
            document.getElementById('coupon-status').value = c.status;
            document.getElementById('coupon-expiry').value = c.expiry || '';
            document.getElementById('couponModal').classList.remove('hidden');
            document.getElementById('couponModal').classList.add('flex');
        }

        function deleteCoupon(id) {
            const c = coupons.find(x => x.id === id);
            addAuditLog('BORRADO_CUPON', `Borrado de cup√≥n: ${c.code}`, 'ALTA', id, 'AJUSTES');
            coupons = coupons.filter(x => x.id !== id);
            saveToStorage('coupons', coupons);
            renderCoupons();
            closeConfirmModal();
        }

        // Global Confirmation
        function confirmDelete(callback) {
            deleteCallback = callback;
            document.getElementById('confirmModal').classList.remove('hidden');
            document.getElementById('confirmModal').classList.add('flex');

            document.getElementById('confirm-action-btn').onclick = () => {
                deleteCallback();
            };
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.add('hidden');
            document.getElementById('confirmModal').classList.remove('flex');
        }
        function resetDemoData() {
            // Personalizamos la modal de confirmaci√≥n para el Reset Nuclear
            const modal = document.getElementById('confirmModal');
            const iconContainer = modal.querySelector('.w-20.h-20');
            const icon = modal.querySelector('.material-symbols-outlined');
            const title = modal.querySelector('h3');
            const desc = modal.querySelector('p');
            const confirmBtn = document.getElementById('confirm-action-btn');

            // Configuraci√≥n visual "Nuclear"
            iconContainer.classList.replace('bg-red-500/10', 'bg-brandPurple/10');
            iconContainer.classList.replace('text-red-500', 'text-brandPurple');
            icon.innerText = 'restart_alt';
            title.innerText = '¬øRESETEO TOTAL?';
            desc.innerText = 'Esta acci√≥n borrar√° todas las reservas, clientes y configuraciones. El sistema volver√° a su estado inicial de f√°brica.';
            confirmBtn.innerText = 'S√ç, REINICIAR TODO';
            confirmBtn.classList.replace('bg-red-500', 'bg-brandPurple');
            confirmBtn.classList.replace('shadow-red-500/20', 'shadow-brandPurple/20');

            // Acci√≥n al confirmar
            confirmBtn.onclick = () => {
                BoxroomerReset.execute();
            };

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
    </script>
</body>

</html>