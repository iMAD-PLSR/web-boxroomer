<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Iniciar Sesi√≥n | BOXROOMER</title>

    <!-- Icons & Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&family=Outfit:wght@300;400;500;700;900&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../assets/js/tailwind.config.js"></script>

    <style>
        body {
            font-family: 'Outfit', sans-serif;
        }
    </style>
</head>

<body
    class="bg-[#0A0510] text-white min-h-screen flex flex-col items-center justify-center p-6 relative overflow-hidden">

    <!-- Background Decor (Premium Blobs) -->
    <div
        class="absolute -top-40 -left-40 w-[600px] h-[600px] bg-brandPurple/20 rounded-full blur-[120px] animate-pulse">
    </div>
    <div class="absolute -bottom-40 -right-40 w-[500px] h-[500px] bg-blue-600/10 rounded-full blur-[100px]"></div>
    <div
        class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-[0.03] pointer-events-none">
    </div>

    <!-- Card Container -->
    <div
        class="bg-white/[0.03] backdrop-blur-2xl border border-white/10 w-full max-w-sm p-10 rounded-[3rem] shadow-[0_32px_64px_-16px_rgba(0,0,0,0.5)] relative z-10">

        <!-- Header -->
        <div class="text-center mb-10">
            <div
                class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-brandPurple to-purple-400 rounded-3xl shadow-lg shadow-brandPurple/20 mb-6 group hover:scale-110 transition-transform duration-500">
                <span class="material-symbols-outlined text-white text-3xl">robot_2</span>
            </div>
            <h1 class="text-3xl font-black text-white tracking-tighter italic uppercase">Mi <span
                    class="text-brandPurple underline decoration-brandPurple/30">Trastero</span></h1>
            <p class="text-slate-400 text-[10px] font-black uppercase tracking-[0.2em] mt-2">Acceso Seguro BOXROOMER</p>
        </div>

        <!-- Form -->
        <form onsubmit="handleLogin(event)" class="space-y-5">

            <!-- Email Input -->
            <div class="space-y-2">
                <label class="text-[10px] uppercase font-black tracking-widest text-brandPurple/80 pl-4">Tu
                    Email</label>
                <div class="relative group">
                    <span
                        class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 text-lg group-focus-within:text-brandPurple transition-colors">mail</span>
                    <input type="email" placeholder="hola@boxroomer.com" required
                        class="w-full bg-white/[0.03] border border-white/10 rounded-2xl py-4 pl-12 pr-4 text-sm font-bold outline-none focus:border-brandPurple focus:bg-white/5 transition-all text-white placeholder:text-slate-600">
                </div>
            </div>

            <!-- Password Input -->
            <div class="space-y-2">
                <div class="flex justify-between items-center pr-2">
                    <label
                        class="text-[10px] uppercase font-black tracking-widest text-brandPurple/80 pl-4">Contrase√±a</label>
                    <a href="#"
                        class="text-[9px] font-black text-slate-500 uppercase hover:text-brandPurple transition-colors tracking-tighter">¬øOlvidada?</a>
                </div>
                <div class="relative group">
                    <span
                        class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 text-lg group-focus-within:text-brandPurple transition-colors">lock</span>
                    <input type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required
                        class="w-full bg-white/[0.03] border border-white/10 rounded-2xl py-4 pl-12 pr-4 text-sm font-bold outline-none focus:border-brandPurple focus:bg-white/5 transition-all text-white placeholder:text-slate-600">
                </div>
            </div>

            <!-- Submit Button -->
            <button type="submit"
                class="w-full group relative bg-brandPurple text-white py-4 rounded-2xl font-black uppercase text-xs tracking-[0.2em] shadow-xl shadow-brandPurple/20 hover:scale-[1.02] hover:shadow-2xl active:scale-[0.98] transition-all flex items-center justify-center gap-2 mt-4 overflow-hidden">
                <div
                    class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-1000">
                </div>
                <span class="relative">Entrar al Panel</span>
                <span class="material-symbols-outlined text-sm relative">arrow_forward</span>
            </button>

        </form>

        <!-- Divider -->
        <div class="relative flex py-8 items-center">
            <div class="flex-grow border-t border-white/5"></div>
            <span class="flex-shrink mx-4 text-white/20 text-[9px] font-black uppercase tracking-widest">O contin√∫a
                con</span>
            <div class="flex-grow border-t border-white/5"></div>
        </div>

        <!-- Social Login (Google) -->
        <button onclick="handleGoogleLogin()"
            class="w-full bg-white/[0.02] border border-white/10 text-white py-4 rounded-2xl font-bold text-xs flex items-center justify-center gap-3 hover:bg-white/[0.05] transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" class="w-5 h-5">
                <path fill="#FFC107"
                    d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.697-6.101,8-11.303,8c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z">
                </path>
                <path fill="#FF3D00"
                    d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z">
                </path>
                <path fill="#4CAF50"
                    d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z">
                </path>
                <path fill="#1976D2"
                    d="M43.611,20.083L43.595,20L42,20H24v8h11.303c-0.792,2.251-2.22,4.147-4.011,5.488l6.19,5.238C37.483,38.72,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z">
                </path>
            </svg>
            Google Account
        </button>

        <!-- Register Link -->
        <div class="text-center mt-10">
            <p class="text-xs font-medium text-slate-500">¬øA√∫n no tienes espacio? <a href="registro.html"
                    class="text-brandPurple font-black hover:underline uppercase tracking-tighter ml-1">Reg√≠strate
                    ahora</a></p>
        </div>

    </div>

    <!-- Back to Home -->
    <a href="../index.html"
        class="absolute bottom-8 text-slate-500 text-[10px] font-black uppercase tracking-[0.2em] hover:text-brandPurple transition-colors flex items-center gap-2">
        <span class="material-symbols-outlined text-sm">west</span> Volver al inicio
    </a>

    <!-- Supabase SDK & Config -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/supabase-config.js"></script>
    <script src="../assets/js/supabase-client.js"></script>

    <script>
        // Helper to determine redirect target
        function getRedirectTarget(role, email = '') {
            const urlParams = new URLSearchParams(window.location.search);
            const returnUrl = urlParams.get('returnUrl');

            // ü¶∏‚Äç‚ôÇÔ∏è SUPERADMIN BYPASS
            let finalRole = role;
            if (email === 'israel.madrigal@pluser.es') {
                finalRole = 'admin';
                console.log("üëë [Auth] Superadmin detectado.");
            }

            if (returnUrl) return returnUrl;

            if (finalRole === 'admin') return 'admin_dashboard.html';
            if (finalRole === 'driver') return 'driver_dashboard.html';
            return 'cliente_dashboard.html';
        }

        async function handleLogin(e) {
            e.preventDefault();

            const emailInput = e.target.querySelector('input[type="email"]');
            const passwordInput = e.target.querySelector('input[type="password"]');

            const email = emailInput ? emailInput.value.toLowerCase().trim() : '';
            const password = passwordInput ? passwordInput.value : '';

            // Loading UI
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="material-symbols-outlined animate-spin text-lg">sync</span> <span class="ml-2 italic uppercase tracking-widest text-[10px] font-black">Validando...</span>';

            // 1. SUPABASE REAL AUTH (If Configured)
            if (window.supabaseClient) {
                console.log("üîê [Auth] Attempting real Supabase Login...");
                try {
                    const { data, error } = await window.supabaseClient.auth.signInWithPassword({
                        email,
                        password
                    });

                    if (error) throw error;

                    // Fetch user role from profile
                    const { data: profile } = await window.supabaseClient
                        .from('profiles')
                        .select('role')
                        .eq('id', data.user.id)
                        .maybeSingle();

                    const role = profile?.role || data.user.user_metadata?.role || 'client';
                    window.location.href = getRedirectTarget(role, email);
                    return; // Stop here

                } catch (err) {
                    console.error("‚ùå Auth Error:", err);
                    alert("Error de acceso: " + (err.message || "Credenciales incorrectas"));
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    return;
                }
            }

            // 2. MOCK DATA FALLBACK (If no Supabase keys)
            console.warn("üõ°Ô∏è [Auth] Demo Mode: Falling back to Local Simulation.");
            setTimeout(() => {
                if (email === 'admin@boxroomer.com') {
                    window.location.href = 'admin_dashboard.html';
                } else if (email.includes('driver')) {
                    window.location.href = 'driver_dashboard.html';
                } else {
                    const dashboardData = {
                        userName: "Israel Madrigal",
                        volume: 0,
                        status: 'active',
                        pickupDate: '-',
                        pickupTime: '-',
                        plan: 'Sin Plan Activo'
                    };
                    if (!localStorage.getItem('BOXROOMER_DASHBOARD_DATA')) {
                        localStorage.setItem('BOXROOMER_DASHBOARD_DATA', JSON.stringify(dashboardData));
                    }
                    window.location.href = 'cliente_dashboard.html';
                }
            }, 1500);
        }

        // 3. GOOGLE LOGIN HANDLER
        async function handleGoogleLogin() {
            if (!window.supabaseClient) {
                alert("Servicio no disponible. Contacte con soporte.");
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const returnUrl = urlParams.get('returnUrl');

            // Build absolute URL for redirect
            let finalRedirect = window.location.origin + '/pages/login.html';
            if (returnUrl) {
                finalRedirect = window.location.origin + '/pages/' + returnUrl;
            }

            console.log("üîÑ Starting Google Auth, redirect to:", finalRedirect);

            const { data, error } = await window.supabaseClient.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    redirectTo: finalRedirect
                }
            });
            if (error) console.error("Google Auth Error:", error);
        }

        // 4. CHECK SESSION ON LOAD (Handle OAuth Redirect or Existing Session)
        window.addEventListener('DOMContentLoaded', async () => {
            if (window.supabaseClient) {
                const { data: { session } } = await window.supabaseClient.auth.getSession();
                if (session) {
                    console.log("‚úÖ Session found as user:", session.user.id);
                    // 1. Check/Create profile
                    let role = 'client';
                    try {
                        const { data: profile, error: profErr } = await window.supabaseClient
                            .from('profiles')
                            .select('role')
                            .eq('id', session.user.id)
                            .maybeSingle();

                        if (!profile && !profErr) {
                            console.log("üÜï Profile missing. Creating...");
                            const { data: newProfile, error: insErr } = await window.supabaseClient
                                .from('profiles')
                                .insert({
                                    id: session.user.id,
                                    email: session.user.email,
                                    full_name: session.user.user_metadata?.full_name || 'Nuevo Usuario',
                                    role: 'client' // Default
                                })
                                .select()
                                .single();
                            if (insErr) console.error("Error creating profile:", insErr);
                            else console.log("‚úÖ Profile created successfully.");
                        } else if (profile) {
                            role = profile.role;
                        }
                    } catch (e) {
                        console.error("Profile sync error:", e);
                    }

                    // 2. Redirect
                    window.location.href = getRedirectTarget(role, session.user.email);
                }
            }
        });
    </script>

</body>

</html>